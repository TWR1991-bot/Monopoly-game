<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é æ‹Œå» å¤§äº¨ - å°ˆæ¥­æµç¨‹æ•™å­¸ç‰ˆ (æœ¬åœ°å–®æ©Ÿ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --bg-industrial: #f8fafc; --chrome-yellow: #FFB900; --start-green: #10b981; }
        body { background-color: var(--bg-industrial); font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; overflow-x: hidden; }
        
        #game-board {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            grid-template-rows: repeat(10, 1fr);
            gap: 4px;
            width: 95vw;
            max-width: 900px;
            aspect-ratio: 1 / 1;
            margin: 10px auto;
            background: #cbd5e1;
            padding: 8px;
            border-radius: 20px;
            box-shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.15);
        }

        .tile {
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4px;
            font-size: 0.65rem;
            position: relative;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            min-height: 0;
            overflow: hidden;
        }

        .tile:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); z-index: 50; }
        .tile-header { height: 6px; width: 100%; position: absolute; top: 0; left: 0; border-radius: 8px 8px 0 0; z-index: 5; }
        
        .tile-special { color: #1e293b; font-weight: 900; }
        .tile-yellow { background-color: var(--chrome-yellow) !important; }
        .tile-green { background-color: var(--start-green) !important; color: white; }
        .tile-light-yellow { background-color: #fef9c3 !important; }

        .tile-no {
            position: absolute;
            top: 6px;
            left: 4px;
            font-size: 8px;
            color: #94a3b8;
            font-weight: 800;
            z-index: 10;
        }

        .tile-level {
            position: absolute;
            top: 6px;
            right: 4px;
            font-size: 8px;
            font-weight: 900;
            padding: 1px 4px;
            border-radius: 4px;
            z-index: 10;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        
        .tile-special .tile-no { color: rgba(255, 255, 255, 0.4); }
        .tile-yellow .tile-no { color: rgba(30, 41, 59, 0.4); }
        .tile-light-yellow .tile-no { color: rgba(133, 77, 14, 0.4); }

        .player-token {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            position: absolute;
            bottom: 4px;
            border: 2px solid white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.4);
            z-index: 60;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.8);
            z-index: 100;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
        }
        .active-modal { display: flex; }

        .log-box {
            height: 250px;
            overflow-y: auto;
            background: #1e293b;
            color: #e2e8f0;
            padding: 16px;
            font-family: 'Fira Code', monospace;
            border-radius: 16px;
            font-size: 0.75rem;
            border: 1px solid #334155;
        }

        .board-center {
            grid-area: 2 / 2 / 10 / 10;
            background: linear-gradient(rgba(255,255,255,0.9), rgba(255,255,255,0.9)), 
                        url('https://images.unsplash.com/photo-1541913066827-400e970a2ad1?auto=format&fit=crop&w=1200&q=80');
            background-size: cover;
            background-position: center;
            border: 4px dashed #cbd5e1;
            border-radius: 3rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 10px;
            pointer-events: none;
            position: relative;
            padding: 20px;
        }
        
        .rules-container {
            text-align: left;
            z-index: 10;
            max-width: 85%;
        }

        .rules-title {
            font-size: 16px;
            font-weight: 900;
            color: #334155;
            border-bottom: 2px solid var(--chrome-yellow);
            display: inline-block;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .rule-item {
            font-size: 11px;
            color: #64748b;
            margin-bottom: 4px;
            line-height: 1.4;
            font-weight: 500;
            display: flex;
            align-items: flex-start;
            gap: 6px;
        }

        .rule-item::before { content: "â–ª"; color: var(--chrome-yellow); font-weight: bold; }

        .loop-watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-15deg);
            font-size: 120px;
            font-weight: 900;
            color: rgba(100, 116, 139, 0.05);
            pointer-events: none;
            z-index: 1;
        }

        .start-label {
            font-size: 7px;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.2);
            padding: 1px 4px;
            border-radius: 4px;
            margin-top: 2px;
            text-transform: uppercase;
        }

        #setup-screen {
            position: fixed;
            inset: 0;
            background: var(--bg-industrial);
            z-index: 200;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .durability-bar-container {
            width: 80%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            margin-top: 4px;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .durability-bar {
            height: 100%;
            transition: width 0.5s ease-in-out, background-color 0.3s;
        }
    </style>
</head>
<body class="p-2 md:p-6 text-slate-800">

<!-- éŠæˆ²åˆå§‹è¨­å®šç•«é¢ -->
<div id="setup-screen">
    <div class="bg-white p-10 rounded-[3rem] shadow-2xl text-center max-w-md w-full mx-4 border-b-8 border-yellow-400">
        <h1 class="text-4xl font-black text-slate-800 mb-2 italic">é æ‹Œå» å¤§äº¨</h1>
        <p class="text-slate-400 font-bold mb-8 uppercase tracking-widest">å» å€ä½œæ¥­æµç¨‹æ•™å­¸ç³»çµ±</p>
        
        <p class="text-sm font-bold text-slate-600 mb-6">è«‹é¸æ“‡åƒèˆ‡ä½œæ¥­çš„äººæ•¸ï¼š</p>
        <div class="grid grid-cols-2 gap-3">
            <button onclick="startGame(1)" class="bg-slate-100 hover:bg-blue-500 hover:text-white py-3 rounded-xl font-black transition-all">1 äººç·´ç¿’</button>
            <button onclick="startGame(2)" class="bg-slate-100 hover:bg-blue-500 hover:text-white py-3 rounded-xl font-black transition-all">2 äººå°æˆ°</button>
            <button onclick="startGame(3)" class="bg-slate-100 hover:bg-blue-500 hover:text-white py-3 rounded-xl font-black transition-all">3 äººç«¶è³½</button>
            <button onclick="startGame(4)" class="bg-slate-100 hover:bg-blue-500 hover:text-white py-3 rounded-xl font-black transition-all">4 äººå¤§æœƒæˆ°</button>
            <button onclick="startGame(5)" class="bg-slate-100 hover:bg-blue-500 hover:text-white py-3 rounded-xl font-black transition-all">5 äººåœ˜é«”è³½</button>
            <button onclick="startGame(6)" class="bg-slate-100 hover:bg-blue-500 hover:text-white py-3 rounded-xl font-black transition-all">6 äººå¤§æ»¿è²«</button>
        </div>
        <p class="mt-8 text-[10px] text-slate-300">æœ¬ç³»çµ±ç‚ºæœ¬åœ°å–®æ©Ÿç‰ˆæœ¬ï¼Œæ‰€æœ‰è³‡æ–™å„²å­˜æ–¼ç€è¦½å™¨åˆ†é ä¸­</p>
    </div>
</div>

<div class="max-w-7xl mx-auto">
    <header class="flex flex-col lg:flex-row justify-between items-center mb-8 bg-white p-6 rounded-[2rem] shadow-sm border-b-4 border-slate-200">
        <div class="text-center lg:text-left">
            <h1 class="text-3xl font-black text-slate-800 tracking-tighter italic">é æ‹Œå» å¤§äº¨ <span class="text-blue-600">OFFLINE</span></h1>
            <p id="user-info" class="text-xs text-slate-400 font-bold tracking-[0.2em] uppercase mt-1 italic">ç³»çµ±é‹è¡Œä¸­ - å» å‹™é…ç½®å·²å„ªåŒ–</p>
        </div>
        <div class="flex items-center gap-8 mt-4 lg:mt-0">
            <div class="bg-emerald-50 px-6 py-3 rounded-2xl border border-emerald-100 text-center">
                <p class="text-[10px] text-emerald-500 font-black uppercase tracking-widest">ç•¶å‰æŠ€è¡“å“¡è³‡é‡‘</p>
                <div id="player-balance" class="text-3xl font-black text-emerald-700">$ --</div>
            </div>
            <div id="turn-indicator" class="px-8 py-3 rounded-full font-black text-sm shadow-sm transition-all uppercase tracking-widest text-center text-white">æº–å‚™é–‹å§‹...</div>
        </div>
    </header>

    <div class="grid grid-cols-1 xl:grid-cols-4 gap-8">
        <div class="xl:col-span-1 space-y-6">
            <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100">
                <h3 class="font-black text-slate-700 mb-5 flex items-center gap-3 text-sm uppercase tracking-wide">
                    <span class="w-2 h-6 bg-yellow-400 rounded-full"></span> ä½œæ¥­å“¡æ¸…å–®
                </h3>
                <div id="players-list" class="space-y-3"></div>
            </div>
            <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100">
                <h3 class="font-black text-slate-700 mb-5 flex items-center gap-3 text-sm uppercase tracking-wide">
                    <span class="w-2 h-6 bg-blue-500 rounded-full"></span> å» å€é€šè¨Šæ—¥èªŒ
                </h3>
                <div id="game-logs" class="log-box"></div>
            </div>
        </div>

        <div class="xl:col-span-3">
            <div id="game-board"></div>
            <div class="mt-8 flex gap-4">
                <button id="roll-btn" class="flex-1 bg-slate-900 hover:bg-slate-800 text-white font-black py-6 rounded-3xl shadow-2xl transition-all text-xl flex items-center justify-center gap-4 group">
                    <span class="group-hover:rotate-12 transition-transform">ğŸ²</span> å•Ÿå‹•ç”Ÿç”¢å¾ªç’°
                </button>
                <button onclick="handleSellCurrent()" class="px-10 bg-white hover:bg-red-50 text-red-500 font-black rounded-3xl border-2 border-red-100 transition-all text-sm uppercase">
                    è®Šè³£è¨­å‚™
                </button>
            </div>
        </div>
    </div>
</div>

<div id="property-modal" class="modal">
    <div class="bg-white rounded-[2.5rem] p-10 max-w-lg w-full mx-4 shadow-2xl relative overflow-hidden">
        <div id="prop-color" class="absolute top-0 left-0 w-full h-4"></div>
        <div class="flex justify-between items-start mb-6">
            <div>
                <h2 id="prop-name" class="text-3xl font-black text-slate-800 mt-2">è¨­å‚™åç¨±</h2>
                <div class="flex items-center gap-2 mt-2">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">å …å›ºå€¼</span>
                    <div class="w-32 h-2 bg-slate-100 rounded-full overflow-hidden">
                        <div id="prop-durability-bar" class="h-full transition-all duration-500"></div>
                    </div>
                    <span id="prop-durability-text" class="text-xs font-black">100/100</span>
                </div>
            </div>
            <div class="bg-blue-50 px-5 py-3 rounded-2xl border border-blue-100 text-center">
                <p class="text-[10px] text-blue-400 font-black uppercase">ç­‰ç´š</p>
                <p id="prop-level" class="text-2xl font-black text-blue-600">Lv.1</p>
            </div>
        </div>
        <div class="flex items-center gap-3 mb-6" id="prop-price-container">
            <span class="bg-slate-100 px-3 py-1 rounded-lg text-[10px] font-black text-slate-500 uppercase tracking-widest">å…¬å¸å ±åƒ¹</span>
            <span id="prop-price" class="text-2xl font-black text-slate-700">$0</span>
        </div>
        <div id="prop-desc" class="bg-slate-50 p-6 rounded-2xl text-sm text-slate-600 leading-relaxed border border-slate-100 mb-8 italic whitespace-pre-wrap">ä»‹ç´¹å…§å®¹è¼‰å…¥ä¸­...</div>
        <div id="upgrade-section" class="mb-8 hidden">
            <p class="font-black text-slate-700 text-xs uppercase mb-3 tracking-widest flex items-center gap-2">
                <span class="w-1 h-3 bg-yellow-400 rounded-full"></span> å‡ç´šé…ä»¶èˆ‡æ¨¡çµ„
            </p>
            <div id="upgrade-list" class="space-y-3"></div>
        </div>
        <div class="grid grid-cols-2 gap-4 mb-8" id="prop-fees-container">
            <div class="p-4 bg-red-50 border border-red-100 rounded-2xl">
                <p class="text-[9px] text-red-400 font-black uppercase mb-1 tracking-wider">æ•…éšœç¶­ä¿®æ”¯å‡º</p>
                <p id="prop-fee-repair" class="text-xl font-black text-red-600">-$0</p>
            </div>
            <div class="p-4 bg-orange-50 border border-orange-100 rounded-2xl">
                <p class="text-[9px] text-orange-400 font-black uppercase mb-1 tracking-wider">å®šæœŸä¿é¤Šæ”¯å‡º</p>
                <p id="prop-fee-maint" class="text-xl font-black text-orange-600">-$0</p>
            </div>
        </div>
        <div class="flex flex-col gap-3" id="prop-actions"></div>
    </div>
</div>

<div id="msg-modal" class="modal">
    <div class="bg-white rounded-[3rem] p-12 max-w-md w-full mx-4 text-center shadow-2xl border border-slate-100">
        <div id="msg-icon" class="text-8xl mb-8">ğŸ“¢</div>
        <h3 id="msg-title" class="text-2xl font-black text-slate-800 mb-4 tracking-tight">é€šçŸ¥å…§å®¹</h3>
        <p id="msg-body" class="text-slate-500 mb-10 text-lg leading-relaxed">ç”Ÿç”¢ç·šç‹€æ…‹æ›´æ–°ä¸­...</p>
        <div id="msg-custom-content" class="mb-6 hidden"></div>
        <button id="msg-close-btn" onclick="closeModal('msg-modal')" class="w-full bg-slate-900 text-white py-5 rounded-[1.5rem] font-black shadow-xl hover:bg-slate-800 transition-all text-xl">ç¢ºèªæ”¶æ‚‰</button>
    </div>
</div>

<script>
    let players = [];
    let currentTurnPlayerIdx = 0;
    let rollAgain = false;

    // --- è¼‰å…·èˆ‡åˆå§‹æ•¸æ“š ---
    const VEHICLE_POOL = [
        { name: "é æ‹Œè»Š", icon: "ğŸš›" },
        { name: "æ°´æ³¥è»Š", icon: "ğŸšš" },
        { name: "ç ‚çŸ³è»Š", icon: "ğŸšœ" },
        { name: "è½è»Š", icon: "ğŸš—" },
        { name: "è²¨è»Š", icon: "ğŸš" },
        { name: "å †é«˜æ©Ÿ", icon: "âš™ï¸" },
        { name: "å±±è²“", icon: "ğŸ—ï¸" }
    ];

    const INITIAL_TILES = [
        { type: 'special', name: 'ä¸­æ§å®¤', color: '#10b981', desc: 'å…¨å» çš„å¤§è…¦ï¼Œè² è²¬èª¿åº¦ã€ç›£æ§èˆ‡é…æ¯”ç®¡ç†ã€‚èµ·é»æ¥å£ã€‚', specialType: 'start' },
        { type: 'prop', name: 'å¡è»Šå¸æ–™æ–—', price: 850, color: '#3b82f6', desc: 'ç ‚çŸ³è»Šå¸æ–™æ‰¿æ¥çš„æ–—å­ï¼Œä¸Šé¢å®‰è£ç¯©ç¶²å¯å°‡éª¨æéœ‡å‹•éç¯©çµå¡Šåˆ†æ•£ã€‚', fees:{repair:250, maint:85}, upgrades:[{name:'å‡ç´š: é˜²å¡µå±‹', price:250, type:'step', levelReq:1},{name:'å‡ç´š: æ”¶æ–™å®¤', price:550, type:'step', levelReq:2}]},
        { type: 'prop', name: 'å…¥åº«å°¾è¼ªåº§', price: 370, color: '#3b82f6', desc: 'å¸¶é‹æ©Ÿæœ«ç«¯ï¼Œæ”¯æ’è¼¸é€çš®å¸¶ã€‚', fees:{repair:110, maint:35}, upgrades:[{name:'åŠ è³¼: å°¾è¼ªä¿è­·ç¶²', price:150, type:'step', levelReq:1},{name:'æ›´æ›: UKTç³»åˆ—è»¸æ‰¿', price:200, type:'step', levelReq:2}]},
        { type: 'prop', name: 'å…¥åº«å°¾è¼ªæ®µ', price: 450, color: '#3b82f6', desc: 'ä¸»è¦ä¸‹æ–™æ‰¿æ¥è™•ï¼Œä¸€èˆ¬æœƒå®‰è£3~4çµ„çš„æ‹–æ¶ç·©è¡æ»¾ç¨ã€‚', fees:{repair:135, maint:45}, upgrades:[{name:'åŠ è³¼: æ•´æµæ¿', price:150, type:'step', levelReq:1},{name:'åŠ è³¼: ä¸‰è§’çš®å¸¶æ¸…æ½”å™¨', price:200, type:'step', levelReq:2}]},
        { type: 'prop', name: 'å…¥åº«æ©Ÿä¸­æ®µ', price: 650, color: '#3b82f6', desc: 'è¼¸é€è¨­å‚™çš„æ ¸å¿ƒæ¡æ¶ï¼Œ10ï¼­ç‚º1æˆªï¼Œä¸Šå±¤æ¯1Mæœƒå®‰è£1çµ„å‰è¡Œè¼ªï¼Œæ¡æ¶ä¸­æ›¾æ¯2Må®‰è£1çµ„å›ç¨‹è¼ªï¼Œåº•å±¤å®‰è£æ°´æ§½æ‰¿æ¥ç ‚çŸ³ã€‚', fees:{repair:200, maint:65}, upgrades:[{name:'åŠ è³¼: é›™å´ä¿è­·ç¶²', price:250, type:'step', levelReq:1},{name:'åŠ è³¼: å®‰å…¨æ‹‰ç¹©', price:300, type:'step', levelReq:2}]},
        { type: 'prop', name: 'å…¥åº«é ­è¼ªåº§', price: 3000, color: '#3b82f6', desc: 'æ•´æ¢å¸¶é‹æ©Ÿçš„å¸¶å‹•æ ¸å¿ƒï¼Œå®‰è£é¦¬é”åŠæ¸›é€Ÿæ©Ÿä¾†é‹è½‰çš®å¸¶ã€‚', fees:{repair:900, maint:300}, upgrades:[{name:'å‡ç´š: éŒå¥—å¼æ¸›é€Ÿæ©Ÿ', price:600, type:'step', levelReq:1},{name:'æ›´æ›: é™¶ç“·åŒ…è† ', price:800, type:'step', levelReq:2}]},
        
        { type: 'special', name: 'é‹å‹•å ´', color: '#fef9c3', icon: 'ğŸƒ', desc: 'å» å€ä¼‘é–’é‹å‹•ç©ºé–“ã€‚', specialType: 'sports' },
        
        { type: 'prop', name: 'åˆ†æ–™å¸¶é‹æ©Ÿ', price: 500, color: '#a855f7', desc: 'éª¨æåˆ†å€‰ä½œæ¥­è¨­å‚™ï¼Œå„€æ§å¼æ”¶åˆ°ç‰©æ–™ç¨®é¡æœƒå°‡åˆ†æ–™æ—‹è½‰åˆ°æŒ‡å®šå€‰åˆ¥ç­‰å¾…å…¥æ–™ï¼Œåˆ†æ–™å¸¶é‹æ©Ÿå°±åƒä¸€æ¢æ¿ƒç¸®ç‰ˆçš„è¼¸é€å¸¶ï¼Œæ‰€æœ‰çš„å¸¶é‹æ©Ÿç‰©ä»¶éƒ½å®‰è£åœ¨é€™ä¸€å°å°ä¸Šé¢ã€‚', fees:{repair:150, maint:50}, upgrades:[{name:'åŠ è³¼: åˆ†æ–™æ—‹è½‰åº§', price:350, type:'step', levelReq:1}]},
        { type: 'prop', name: 'åˆ†æ–™å¹³å°', price: 400, color: '#a855f7', desc: 'ç‚ºå…«å¦è¨­è¨ˆï¼Œç”¨æ–¼ç¶­ä¿®åˆ†æ–™æ©Ÿã€‚', fees:{repair:120, maint:40}, upgrades:[{name:'åŠ è³¼: ä¸Šæ–¹èµ°å»Š', price:250, type:'step', levelReq:1}]},
        { type: 'special', name: 'æ©Ÿæœƒæˆ–å‘½é‹', icon: 'â“', desc: 'ç”Ÿç”¢ä¸­çš„æœªçŸ¥è®Šæ•¸ã€‚', specialType: 'chance_or_fate' },
        { type: 'prop', name: 'éª¨æåº«', price: 5400, color: '#a855f7', desc: 'ä¸»è¦å­˜æ”¾éª¨æçš„åœ°æ–¹ï¼Œè¦æ ¼æœ‰9Mã€10Mã€12Mï¼Œæœƒä¾æ“šæ¥­ä¸»å­˜é‡éœ€æ±‚å¢åŠ å±¤æ•¸èˆ‡å€‰æ•¸ã€‚', fees:{repair:1600, maint:540}, upgrades:[{name:'å®‰è£: éµè£½è…³æŸ±', price:895, type:'choice'},{name:'å®‰è£: RCè…³æŸ±', price:1200, type:'choice'},{name:'åŠ è³¼: éª¨æåº«éµå±‹', price:1350, type:'step', levelReq:2}]},
        { type: 'prop', name: 'ç ‚çŸ³é–˜é–€', price: 70, color: '#a855f7', desc: 'éª¨æåº«çš„ä¸‹æ–™é–‹é—œé–˜é–€ï¼Œå¾å¤–å‹ä¾†çœ‹é–˜é–€ç‚ºåœ“å¼§å½¢çš„æ˜¯ç ‚é–˜é–€ï¼ŒæŠ˜è§’å½¢çš„æ˜¯çŸ³é–˜é–€ã€‚', fees:{repair:20, maint:10} },
        { type: 'prop', name: 'ç ‚çŸ³è¨ˆé‡æ¡¶', price: 500, color: '#a855f7', desc: 'è¨ˆç®—ç ‚å­èˆ‡çŸ³é ­æ¯”é‡çš„è¨­å‚™ï¼Œç ‚è¨ˆé‡é è¿‘æœ«ç«¯è¥¯åº•ï¼Œæ¯ç«‹æ–¹çš„æ··å‡åœŸç´„æ­é…ç ‚çŸ³å„900kgçš„éª¨æ', fees:{repair:150, maint:50} },
        
        { type: 'special', name: 'éŠ€è¡Œ', color: '#fef9c3', icon: 'ğŸ¦', desc: 'å» å€è²¡å‹™ä¸­å¿ƒã€‚å¯é€²è¡Œå€Ÿè²¸æœå‹™ã€‚', specialType: 'bank' },
        
        { type: 'prop', name: 'ä¸»å°¾è¼ªåº§', price: 370, color: '#f97316', desc: 'ä¸»æ©Ÿå¸¶é‹æ©Ÿæœ«ç«¯ï¼Œæ”¯æ’è¼¸é€çš®å¸¶ã€‚', fees:{repair:110, maint:35}, upgrades:[{name:'åŠ è³¼: å°¾è¼ªä¿è­·ç¶²', price:150, type:'step', levelReq:1},{name:'æ›´æ›: UKTç³»åˆ—è»¸æ‰¿', price:200, type:'step', levelReq:2}]},
        { type: 'prop', name: 'ä¸»å°¾è¼ªæ®µ', price: 400, color: '#f97316', desc: 'ä¸»è¦ä¸‹æ–™æ‰¿æ¥è™•ï¼Œä¸€èˆ¬æœƒå®‰è£3~4çµ„çš„æ‹–æ¶ç·©è¡æ»¾ç¨ã€‚', fees:{repair:120, maint:40}, upgrades:[{name:'åŠ è³¼: æ•´æµæ¿', price:150, type:'step', levelReq:1},{name:'åŠ è³¼: ä¸‰è§’çš®å¸¶æ¸…æ½”å™¨', price:200, type:'step', levelReq:2}]},
        { type: 'prop', name: 'ä¸»å¸¶æ©Ÿä¸­æ®µ', price: 620, color: '#f97316', desc: 'è¼¸é€è¨­å‚™çš„æ ¸å¿ƒæ¡æ¶ï¼Œ10ï¼­ç‚º1æˆªï¼Œä¸Šå±¤æ¯1Mæœƒå®‰è£1çµ„å‰è¡Œè¼ªï¼Œæ¡æ¶ä¸­æ›¾æ¯2Må®‰è£1çµ„å›ç¨‹è¼ªï¼Œåº•å±¤å®‰è£æ°´æ§½æ‰¿æ¥ç ‚çŸ³ã€‚', fees:{repair:180, maint:60}, upgrades:[{name:'åŠ è³¼: é›™å´ä¿è­·ç¶²', price:250, type:'step', levelReq:1},{name:'åŠ è³¼: å®‰å…¨æ‹‰ç¹©', price:300, type:'step', levelReq:2}]},
        { type: 'prop', name: 'ä¸»é ­è¼ªåº§', price: 2200, color: '#f97316', desc: 'æ•´æ¢å¸¶é‹æ©Ÿçš„å¸¶å‹•æ ¸å¿ƒï¼Œå®‰è£é¦¬é”åŠæ¸›é€Ÿæ©Ÿä¾†é‹è½‰çš®å¸¶ã€‚', fees:{repair:660, maint:220}, upgrades:[{name:'å‡ç´š: éŒå¥—å¼æ¸›é€Ÿæ©Ÿ', price:600, type:'step', levelReq:1},{name:'æ›´æ›: é™¶ç“·åŒ…è† ', price:800, type:'step', levelReq:2}]},
        { type: 'special', name: 'ä¼‘æ¯å®¤', icon: 'â˜•', price: 1500, desc: 'æŠ€è¡“å“¡ä¼‘æ¯äº¤ç­ç©ºé–“ã€‚', specialType: 'rest' },
        { type: 'prop', name: 'éª¨æå¾…æ‹Œæ§½', price: 300, color: '#06b6d4', desc: 'éª¨æåœ¨ä¸»æ©Ÿæ¨“å…§éƒ¨å¾…å‘½è™•ã€‚', fees:{repair:90, maint:30}, upgrades:[{name:'åŠ è³¼: å¾…æ‹Œæ§½é›™é‚Šèµ°å»Š', price:200, type:'step', levelReq:1},{name:'æ›´æ›: é›™å±¤å¾…æ‹Œæ§½', price:450, type:'step', levelReq:2}]},
        { type: 'prop', name: 'ç ‚çŸ³æ»‘æ§½', price: 200, color: '#06b6d4', desc: 'éª¨æé€²åˆ°æ‹Œåˆæ©Ÿçš„éŠœæ¥æ§½é«”ã€‚', fees:{repair:60, maint:20}, upgrades:[{name:'åŠ è£: éœ‡å‹•æ©Ÿ', price:150, type:'step', levelReq:1},{name:'åŠ è³¼: æ»‘æ§½ç¶­ä¿®èµ°é“', price:200, type:'step', levelReq:2}]},
        
        { type: 'special', name: 'æ´—æ‰‹é–“', color: '#fef9c3', icon: 'ğŸš»', desc: 'å…¬å…±è¡›ç”Ÿç©ºé–“ã€‚', specialType: 'restroom' },
        
        { type: 'prop', name: 'æ°´æ³¥æ¡¶', price: 2150, color: '#64748b', desc: 'è£è¼‰è† çµæï¼ˆæ°´æ³¥ã€é£›ç°ã€çˆçŸ³ï¼‰çš„å„²å­˜æ¡¶ï¼Œæ¯é¡†æ¡¶å­˜æ”¾ä¸€ç¨®ç‰©æ–™ã€‚', fees:{repair:645, maint:215}, upgrades:[{name:'åŠ è³¼: æ¡¶ä¸Šé›†å¡µæ©Ÿ', price:400, type:'step', levelReq:1},{name:'åŠ è³¼: æ‰‹å‹•è¶é–¥', price:250, type:'step', levelReq:2}]},
        { type: 'prop', name: 'èºé‹æ©Ÿ', price: 380, color: '#64748b', desc: 'è† çµæçš„è¼¸é€è¨­å‚™ï¼Œå…§éƒ¨ä½¿ç”¨èºæ—‹è‘‰ç‰‡è¨­è¨ˆã€‚', fees:{repair:110, maint:40} },
        { type: 'prop', name: 'ç²‰é«”è¨ˆé‡æ¡¶', price: 350, color: '#64748b', desc: 'è¨ˆç®—è† çµææ¯”é‡ï¼Œæ¯ç«‹æ–¹çš„æ··å‡åœŸç´„æ­é…200kgçš„æ°´æ³¥å’Œå„100kgçš„é£›ç°ã€çˆçŸ³ã€‚', fees:{repair:100, maint:35} },
        { type: 'prop', name: 'ç²‰é«”æ»‘æ§½', price: 150, color: '#64748b', desc: 'ç²‰é«”é€²å…¥æ‹Œåˆæ©Ÿçš„éŠœæ¥è¨­å‚™ï¼Œä¸­é–“ä½¿ç”¨æ’ç®¡æ­é…ä¸çŸ¥ä¸ç®¡åšéŠœæ¥è¨­è¨ˆï¼Œé˜²æ­¢ç²‰å¡µå¤–æº¢ã€‚', fees:{repair:45, maint:15} },
        { type: 'prop', name: 'ä¸»æ©Ÿé›†å¡µæ©Ÿ', price: 500, color: '#06b6d4', desc: 'ä¸»è¦å¸å–æ‹Œåˆæ©Ÿå…§çš„ç²‰å¡µï¼Œé€éè†œç‰‡é–¥å……æ°£å°‡å¸ƒç®¡ç²‰å¡µå¹è½å¾Œå›æ”¶å†åˆ©ç”¨ã€‚', fees:{repair:150, maint:50} },
        { type: 'special', name: 'æ©Ÿæœƒæˆ–å‘½é‹', icon: 'â“', desc: 'å» å‹™çªç™¼ç‹€æ³ã€‚', specialType: 'chance_or_fate' },
        { type: 'prop', name: 'è—¥åŠ‘è¨ˆé‡è¨­å‚™', price: 180, color: '#06b6d4', desc: 'è—¥åŠ‘æ¯”é‡è¨ˆç®—è¨­å‚™ï¼Œæ¯ç«‹æ–¹æ··å‡åœŸç´„æ­é…5kgçš„è—¥åŠ‘ã€‚', fees:{repair:55, maint:18} },
        { type: 'prop', name: 'æ¸…æ°´æ¡¶', price: 280, color: '#06b6d4', desc: 'ä½æ–¼ä¸»æ©Ÿå…§éƒ¨çš„æ¸…æ°´å„²å­˜ç³»çµ±ï¼Œä½œç‚ºä¸€å€‹ä¸­è½‰ç«™æå‡ç”Ÿç”¢æ•ˆç‡ã€‚', fees:{repair:85, maint:28}, upgrades:[{name: 'åŠ è£: å†°æ°´ç³»çµ±', price: 350, type: 'addon'}]},
        { type: 'prop', name: 'ä¸»æ©Ÿæ±™æ°´æ”ªæ‹Œæ¡¶', price: 300, color: '#06b6d4', desc: 'æ±™æ°´åœ¨ä¸»æ©Ÿæ¨“çš„æš«å­˜è¨­å‚™ï¼Œå…§éƒ¨ä½¿ç”¨æ”ªæ‹Œè¨­è¨ˆï¼Œè®“æ·¤æ³¥ä¸æœƒæ²‰æ¾±é€ æˆçµå¡Šï¼Œæ¡¶å­ä¸Šé¢åŠ è£ç‘æ°´ç³»çµ±å¯æœ‰é™çš„å°‡æ¡¶å…§å£çš„æ·¤æ³¥æ´—è½æ¸›å°‘é™„è‘—ç‹€æ³ã€‚', fees:{repair:90, maint:30} },
        { type: 'prop', name: 'æ°´è¨ˆé‡æ¡¶', price: 260, color: '#06b6d4', desc: 'è¨ˆç®—æ°´é¡æ¯”ä¾‹ï¼Œæ¯ç«‹æ–¹çš„æ··å‡åœŸç´„æ­é…150kgçš„æ°´(åŒ…å«æ¸…æ°´ã€æ±™æ°´ã€å†°æ°´)ã€‚', fees:{repair:75, maint:26} },
        
        { type: 'special', name: 'é†«è­·å®¤', color: '#fef9c3', icon: 'ğŸ¥', desc: 'å“¡å·¥å¥åº·æª¢æŸ¥ç«™ã€‚', specialType: 'infirmary' },
        
        { type: 'prop', name: 'æ°´ç·©è¡æ¡¶', price: 300, color: '#f43f5e', desc: 'å‡ºæ°´æ™‚çš„ä¸€å€‹ç·©è¡ç©ºé–“ã€‚', fees:{repair:90, maint:30} },
        { type: 'prop', name: 'æ‹Œåˆæ©Ÿ', price: 3300, color: '#f43f5e', desc: 'é æ‹Œå» çš„å¿ƒè‡Ÿï¼Œä¸»è¦ç”¨æ–¼æ··æ‹Œæ‰€æœ‰åŸç‰©æ–™ï¼Œæ¯åˆ†é˜å¯ç”¢å‡ºï¼“æ–¹çš„æ··å‡åœŸï¼Œè½‰é€Ÿæ¯åˆ†é˜å¯ç¹³æ‹Œ23~26ä¸‹', fees:{repair:1000, maint:330} },
        { type: 'prop', name: 'æ··å‡åœŸå„²æ–—', price: 800, color: '#f43f5e', desc: 'æ··åˆæˆå“ç·©è¡å€ã€‚', fees:{repair:240, maint:80}, upgrades:[{name: 'åŠ è£: åŠ›éœ¸å¼å¤¾å…·', price: 150, type: 'step', levelReq: 1},{name: 'åŠ è£: å„²æ–—ç¶­ä¿®å¹³å°', price: 150, type: 'step', levelReq: 2}]}
    ];

    const CHANCE_EVENTS = [
        { text: "è€é—†è‡¨æ™‚å¤–æ´¾å‡ºå·®ï¼Œæš«åœä¸€å›åˆ", effect: (p) => { if(p.skipImmunity > 0) { p.skipImmunity--; return "é«”åŠ›å……æ²›ï¼ŒæŠµæ¶ˆåœç•™ï¼"; } p.skipTurns = 1; }, icon: "ğŸ’¼" },
        { text: "å¤©æ°£è½‰æ¶¼ç”Ÿç—…ç™¼ç‡’ï¼Œåœ¨å®¶ä¼‘æ¯åœç•™ä¸€å›åˆ", effect: (p) => { if(p.skipImmunity > 0) { p.skipImmunity--; return "é«”åŠ›å……æ²›ï¼ŒæŠµæ¶ˆåœç•™ï¼"; } p.skipTurns = 1; }, icon: "ğŸ¤’" },
        { text: "ä¸Šç­é€”ä¸­æ©Ÿè»Šæ•…éšœï¼Œäº‹å‡æ‰£éŒ¢ 200 å…ƒ", effect: (p) => { p.balance -= 200; }, icon: "ğŸ›µ" },
        { text: "é€²å…¥å·¥åœ°æœªæˆ´å®‰å…¨å¸½ï¼Œè¢«æª¢èˆ‰æ‰£ 500 å…ƒ", effect: (p) => { p.balance -= 500; }, icon: "ğŸ‘·" },
        { text: "å—å‚·å‰å¾€ #33 é†«è­·å®¤æ²»ç™‚ä¸¦åœç•™ä¸€å›åˆ", effect: (p) => { p.pos = 32; if(p.skipImmunity > 0) { p.skipImmunity--; return "å·²æŠµé”é†«è­·å®¤ï¼Œä½†é«”åŠ›ä½³ç„¡éœ€åœç•™ï¼"; } p.skipTurns = 1; }, icon: "ğŸ©¹" },
        { text: "è€é—†è‡¨æ™‚å¤–æ´¾æ¥­å‹™å‡ºå·®ï¼Œè³ºå–åŠ ç­è²» 1500 å…ƒ", effect: (p) => { p.balance += 1500; }, icon: "ğŸ’°" },
        { text: "å”åŠ©å®¢æˆ¶è¨­å‚™æ¶ä¿®ï¼Œè³ºå–çé‡‘ 1500 å…ƒ", effect: (p) => { p.balance += 1500; }, icon: "ğŸ”§" },
        { text: "å·¥ä½œè‰¯å¥½è³ºå–çé‡‘ 300 å…ƒ", effect: (p) => { p.balance += 300; }, icon: "â­" },
        { text: "æœªä¾ SOP é–‹æ©Ÿï¼Œç½°æ¬¾ 600 å…ƒ", effect: (p) => { p.balance -= 600; }, icon: "âš ï¸" },
        { text: "ç™¼ç¾æ–™æ–—æ®˜æ–™æœªæ¸…ï¼Œçé‡‘ +300 å…ƒ", effect: (p) => { p.balance += 300; }, icon: "ğŸ§¹" },
        { text: "å¿˜è¨˜å›å¡«ä¿é¤Šç´€éŒ„ï¼Œåœç•™ä¸€å›åˆ", effect: (p) => { if(p.skipImmunity > 0) { p.skipImmunity--; return "ç´€éŒ„å·²è£œï¼Œå…åœç•™ï¼"; } p.skipTurns = 1; }, icon: "ğŸ“" },
        { text: "ä¸»å‹•æé†’åŒäº‹æˆ´å¸½ï¼Œçé‡‘ +400 å…ƒ", effect: (p) => { p.balance += 400; }, icon: "ğŸ‘" },
        { text: "é€²å…¥å·¥åœ°æœªæˆ´å®‰å…¨å¸½ï¼Œæ‰£ 300 å…ƒ", effect: (p) => { p.balance -= 300; }, icon: "ğŸ‘·" },
        { text: "å®Œæˆæ•™è‚²è¨“ç·´ï¼Œå¾€å‰ç§»å‹• 2 æ ¼", effect: (p) => { p.pos = (p.pos + 2) % 36; return "é€²åº¦è¶…å‰ï¼"; }, icon: "ğŸ“–" },
        { text: "é›¨å¤©æœªæ³¨æ„é˜²æ»‘è·Œå€’ï¼Œå‰å¾€ é†«è­·å®¤ åœç•™ä¸€å›åˆ", effect: (p) => { p.pos = 32; if(p.skipImmunity > 0) { p.skipImmunity--; return "ç„¡ç¤™ï¼Œå…åœç•™ï¼"; } p.skipTurns = 1; }, icon: "ğŸŒ§ï¸" },
        { text: "ç¢ºèªé…æ¯”æ­£ç¢ºï¼Œçé‡‘ +500 å…ƒ", effect: (p) => { p.balance += 500; }, icon: "âš–ï¸" },
        { text: "æºé€šä¸è‰¯å»¶èª¤å‡ºè»Šï¼Œæ‰£ 400 å…ƒ", effect: (p) => { p.balance -= 400; }, icon: "ğŸ“" },
        { text: "å”åŠ©èª¿åº¦è‡¨æ™‚åŠ å–®ï¼Œçé‡‘ +600 å…ƒ", effect: (p) => { p.balance += 600; }, icon: "ğŸ“¦" },
        { text: "å‡ºè»Šå–®æœªå³æ™‚å›å ±ï¼Œåœç•™ä¸€å›åˆ", effect: (p) => { if(p.skipImmunity > 0) { p.skipImmunity--; return "å…åœç•™ï¼"; } p.skipTurns = 1; }, icon: "ğŸšš" },
        { text: "ä¸»ç®¡è‡¨æª¢æ—¥ï¼šå…é™¤æœ¬å›åˆç¶­ä¿®è²»", effect: (p) => { p.feeImmunity = true; }, icon: "ğŸ§" },
        { text: "çªç™¼å¤§å–®å®Œæˆï¼Œçé‡‘ +1,000 å…ƒ", effect: (p) => { p.balance += 1000; }, icon: "ğŸ”¥" },
        { text: "è‡¨æ™‚å¤–æ´¾å—è¨“ï¼šåœç•™ä¸€å›åˆ", effect: (p) => { if(p.skipImmunity > 0) { p.skipImmunity--; return "å…åœç•™ï¼"; } p.skipTurns = 1; }, icon: "ğŸ“" }
    ];

    // --- æ ¸å¿ƒéŠæˆ²å‡½æ•¸ ---

    function startGame(count) {
        const colors = ["#3b82f6", "#f43f5e", "#10b981", "#f59e0b", "#a855f7", "#06b6d4"];
        const names = ["æŠ€è¡“å“¡ A", "æŠ€è¡“å“¡ B", "æŠ€è¡“å“¡ C", "æŠ€è¡“å“¡ D", "æŠ€è¡“å“¡ E", "æŠ€è¡“å“¡ F"];
        const shuffledVehicles = [...VEHICLE_POOL].sort(() => Math.random() - 0.5);
        
        players = [];
        for (let i = 0; i < count; i++) {
            players.push({
                id: i,
                name: names[i],
                pos: 0,
                balance: 15000,
                color: colors[i],
                vehicle: shuffledVehicles[i % shuffledVehicles.length],
                owned_data: {},
                skipTurns: 0,
                skipImmunity: 0,
                feeImmunity: false,
                loanDebt: 0,         // è²¸æ¬¾ç¸½é¡
                loanInstallments: 0  // å‰©é¤˜é‚„æ¬¾æœŸæ•¸
            });
        }
        document.getElementById('setup-screen').style.display = 'none';
        initGame();
    }

    function initGame() {
        renderBoard();
        updatePlayersUI();
        updateTurnUI();
        addLog("ğŸ­ å» å€ç”Ÿç”¢å¾ªç’°å•Ÿå‹•");
    }

    function renderBoard() {
        const board = document.getElementById('game-board');
        board.innerHTML = '';
        const side = 10;
        const coords = [];
        for (let x = 0; x < side; x++) coords.push({r: 1, c: x + 1});
        for (let y = 1; y < side - 1; y++) coords.push({r: y + 1, c: side});
        for (let x = side - 1; x >= 0; x--) coords.push({r: side, c: x + 1});
        for (let y = side - 2; y >= 1; y--) coords.push({r: y + 1, c: 1});

        INITIAL_TILES.forEach((data, idx) => {
            const div = document.createElement('div');
            const isGreen = data.specialType === 'start';
            const isPale = data.color === '#fef9c3';
            const isYellow = data.specialType === 'chance_or_fate';
            
            div.className = `tile ${isGreen ? 'tile-green' : (isPale ? 'tile-light-yellow' : (isYellow ? 'tile-yellow' : ''))}`;
            if (data.type === 'special' && !isPale && !isGreen && !isYellow) div.className += ' tile-special';
            
            div.dataset.idx = idx;
            div.style.gridRow = coords[idx].r;
            div.style.gridColumn = coords[idx].c;
            
            if (data.type === 'prop' && data.color) {
                const header = document.createElement('div');
                header.className = 'tile-header';
                header.style.backgroundColor = data.color;
                div.prepend(header);
            }

            const noDiv = document.createElement('div');
            noDiv.className = 'tile-no';
            noDiv.innerText = `#${idx + 1}`;
            div.appendChild(noDiv);

            let owner = players.find(p => p.owned_data[idx]);
            if (owner) {
                const lvDiv = document.createElement('div');
                lvDiv.className = 'tile-level';
                lvDiv.innerText = `Lv.${owner.owned_data[idx].level}`;
                div.appendChild(lvDiv);
            }
            
            const nameDiv = document.createElement('div');
            nameDiv.className = 'font-black px-1 mt-2 leading-tight break-words text-slate-800';
            nameDiv.style.fontSize = '12px';
            nameDiv.innerHTML = data.name.length > 5 ? data.name.substring(0, 4) + '<br>' + data.name.substring(4) : data.name;
            div.appendChild(nameDiv);

            if (isGreen) {
                const label = document.createElement('div');
                label.className = 'start-label';
                label.innerText = 'èµ·é»';
                div.appendChild(label);
            }
            
            if (data.icon) {
                const iconDiv = document.createElement('div');
                iconDiv.className = 'text-xl mt-1 opacity-60';
                iconDiv.innerText = data.icon;
                div.appendChild(iconDiv);
            } else if (data.price) {
                const priceDiv = document.createElement('div');
                priceDiv.className = 'text-blue-500 font-bold mt-1 tracking-tight';
                priceDiv.style.fontSize = '8px';
                priceDiv.innerText = `$${data.price}`;
                div.appendChild(priceDiv);

                if (owner) {
                    const dur = owner.owned_data[idx].durability;
                    const barContainer = document.createElement('div');
                    barContainer.className = 'durability-bar-container';
                    const bar = document.createElement('div');
                    bar.className = 'durability-bar';
                    bar.style.width = dur + '%';
                    bar.style.backgroundColor = dur <= 0 ? '#f43f5e' : (dur < 50 ? '#f59e0b' : '#10b981');
                    barContainer.appendChild(bar);
                    div.appendChild(barContainer);
                }
            }
            board.appendChild(div);
        });

        const center = document.createElement('div');
        center.className = 'board-center';
        center.innerHTML = `
            <div class="loop-watermark">LOOP</div>
            <div class="rules-container">
                <h4 class="rules-title">å» å€ç‡Ÿé‹æ‰‹å†Š</h4>
                <p class="rule-item">éŠ€è¡Œå€Ÿè²¸ï¼šå¯ä¾ç¸½è³‡ç”¢åƒ¹å€¼è²¸æ¬¾ï¼Œç¶“èµ·é»æ‰£ 20% é‚„æ¬¾ï¼Œ5 å›åˆæ¸…å„Ÿã€‚</p>
                <p class="rule-item">å‡ç´šï¼šæ¨™ç¤ºé‚Šæ¡†éš¨ç­‰ç´šæ“´å¼µ (Lv1:ä¸Šå³, Lv2:ä¸Šå³ä¸‹, Lv3:å…¨åŒ…)ã€‚</p>
                <p class="rule-item">å …å›ºå€¼ï¼šæœ€é«˜ç´šè¨­å‚™æ¯æ¬¡åœç•™æ‰£ 2 é»ã€‚ä½æ–¼ 50% ç¶­ä¿®è²»æ¸›åŠã€‚</p>
                <p class="rule-item">336 å¥æª¢ï¼šæˆ¿ä¸»åœç•™è‡ªå·±è³‡ç”¢æ»¿ 3/6/12 æ¬¡ï¼Œå…è²»å›å‡ 5 é»å …å›ºã€‚</p>
                <p class="rule-item">å°ˆæ¥­æ ¼ï¼šé‹å‹•å ´ã€ä¼‘æ¯å®¤ã€æ´—æ‰‹é–“ã€é†«è­·å®¤è§¸ç™¼å¤šæ¨£éš¨æ©Ÿäº‹ä»¶ã€‚</p>
            </div>
        `;
        board.appendChild(center);
    }

    function updatePlayersUI() {
        const listDiv = document.getElementById('players-list');
        listDiv.innerHTML = '';
        document.querySelectorAll('.player-token').forEach(el => el.remove());

        document.querySelectorAll('.tile').forEach(tile => tile.style.boxShadow = ''); 

        players.forEach((p, idx) => {
            const div = document.createElement('div');
            const isCurrent = idx === currentTurnPlayerIdx;
            div.className = `p-3 rounded-2xl flex flex-col gap-1 text-[10px] shadow-sm border ${isCurrent ? 'bg-blue-50 border-blue-200 font-black' : 'bg-white border-transparent'}`;
            div.innerHTML = `
                <div class="flex justify-between items-center">
                    <span><span style="color:${p.color}">â—</span> ${p.vehicle.icon} ${p.name} ${p.skipTurns > 0 ? '(åœç•™)' : ''}</span>
                    <span>$${p.balance}</span>
                </div>
                ${p.loanDebt > 0 ? `<div class="text-[9px] text-red-500 font-bold">æ¬ æ¬¾: $${Math.round(p.loanDebt)} (æœŸæ•¸: ${p.loanInstallments}/5)</div>` : ''}
            `;
            listDiv.appendChild(div);

            if (isCurrent) document.getElementById('player-balance').innerText = `$${p.balance}`;

            const tile = document.querySelector(`[data-idx="${p.pos}"]`);
            if (tile) {
                const token = document.createElement('div');
                token.className = 'player-token';
                token.style.backgroundColor = p.color;
                token.innerText = p.vehicle.icon;
                token.style.transform = `translate(${idx * 3}px, ${idx * 3}px)`;
                tile.appendChild(token);
            }

            Object.keys(p.owned_data).forEach(tileIdx => {
                const el = document.querySelector(`[data-idx="${tileIdx}"]`);
                if (el) {
                    const lv = p.owned_data[tileIdx].level;
                    const tileColor = INITIAL_TILES[tileIdx].color || p.color;
                    const lvTag = el.querySelector('.tile-level');
                    if (lvTag) lvTag.style.backgroundColor = p.color;

                    if (lv === 1) el.style.boxShadow = `inset 0 6px 0 0 ${tileColor}, inset -6px 0 0 0 ${tileColor}`;
                    else if (lv === 2) el.style.boxShadow = `inset 0 6px 0 0 ${tileColor}, inset -6px 0 0 0 ${tileColor}, inset 0 -6px 0 0 ${tileColor}`;
                    else el.style.boxShadow = `inset 0 0 0 6px ${tileColor}`;
                }
            });
        });
    }

    function updateTurnUI() {
        const p = players[currentTurnPlayerIdx];
        if (!p) return;
        const ind = document.getElementById('turn-indicator');
        ind.innerText = rollAgain ? `${p.vehicle.icon} ${p.name} å†æ“²ä¸€æ¬¡ï¼` : `è¼ªåˆ° ${p.name}`;
        ind.style.backgroundColor = p.color;
        ind.className = `px-8 py-3 rounded-full font-black text-sm shadow-sm transition-all tracking-wider text-white animate-pulse`;
    }

    document.getElementById('roll-btn').onclick = () => {
        const p = players[currentTurnPlayerIdx];
        if (!rollAgain) p.feeImmunity = false; 

        if (p.skipTurns > 0) {
            p.skipTurns--;
            addLog(`â³ ${p.name} åœç•™ä¸­ï¼Œå‰©é¤˜ ${p.skipTurns} å›åˆ`);
            showMsg("ä½œæ¥­åœç•™", `${p.name} éœ€åœç•™ä½œæ¥­ï¼Œæœ¬å›åˆè·³éã€‚`, "â³");
            nextTurn();
            return;
        }

        const dice = Math.floor(Math.random() * 6) + 1;
        addLog(`ğŸ² ${p.name} æ“²å‡ºäº† ${dice} é»`);
        
        let oldPos = p.pos;
        let newPos = (p.pos + dice) % 36;
        
        // --- é€šéèµ·é»é‚è¼¯ (åŒ…æ‹¬é‚„æ¬¾) ---
        if (newPos < oldPos) {
            p.balance += 2500;
            addLog(`ğŸ”„ ${p.name} é€šéä¸­æ§å®¤ï¼Œçé‡‘ $2500`);
            
            if (p.loanDebt > 0) {
                let repayment = Math.round(p.loanDebt / p.loanInstallments);
                p.balance -= repayment;
                p.loanDebt -= repayment;
                p.loanInstallments--;
                if (p.loanInstallments <= 0) p.loanDebt = 0;
                addLog(`ğŸ¦ éŠ€è¡Œé‚„æ¬¾ï¼šè‡ªå‹•æ‰£é™¤ $${repayment}`);
            }
        }
        
        p.pos = newPos;
        rollAgain = false; 
        updatePlayersUI();
        handleTile(newPos);
    };

    function isMaxLevel(tileIdx, currentLevel) {
        const t = INITIAL_TILES[tileIdx];
        if (!t.upgrades) return true;
        const steps = t.upgrades.filter(u => u.type === 'step').length;
        const choice = t.upgrades.some(u => u.type === 'choice') ? 1 : 0;
        return currentLevel >= (1 + steps + choice);
    }

    function handleTile(pos, fromEvent = false) {
        const t = INITIAL_TILES[pos];
        const p = players[currentTurnPlayerIdx];
        let owner = players.find(player => player.owned_data[pos]);

        // å …å›ºå€¼æè€—
        if (owner && !fromEvent) {
             const d = owner.owned_data[pos];
             if (isMaxLevel(pos, d.level)) d.durability = Math.max(0, d.durability - 2);
        }

        // 336 æ©Ÿæ¢°å¥æª¢
        if (owner && owner.id === p.id && !fromEvent) {
            owner.owned_data[pos].visitCount++;
            if ([3, 6, 12].includes(owner.owned_data[pos].visitCount)) {
                owner.owned_data[pos].durability = Math.min(100, owner.owned_data[pos].durability + 5);
                showMsg("336 æ©Ÿæ¢°å¥æª¢", `å …å›ºå€¼å›å‡ 5`, "ğŸ”§");
                if (owner.owned_data[pos].visitCount === 12) owner.owned_data[pos].visitCount = 0;
            }
        }
        
        if (t.type === 'prop') {
            if (!owner) showPropModal(pos, true);
            else if (owner.id === p.id) showPropModal(pos, false, true);
            else triggerMaintenance(pos, owner);
        } else if (t.specialType === 'chance_or_fate') {
            triggerChanceOrFateEvent();
        } else if (t.specialType === 'bank') {
            triggerBank(p);
        } else if (t.specialType === 'rest') {
            if (!fromEvent) {
                triggerRandomSpecial(pos, [
                    { t: "ä¼‘æ¯å®¤äº¤æµç¶“é©—ï¼Œå­¸åˆ°æ–°æŠ€å·§ï¼Œå¾€å‰ 1 æ ¼", f: (p)=>{ p.pos = (p.pos+1)%36; updatePlayersUI(); setTimeout(()=>handleTile(p.pos, true), 800); }, i: "ğŸƒ", ra: false },
                    { t: "åˆä¼‘ç¡ééé ­ï¼Œè¢«ä¸»ç®¡é»åï¼Œæ‰£ 200 å…ƒ", f: (p)=>{ p.balance -= 200; }, i: "ğŸ˜´", ra: false },
                    { t: "å¥½å¥½ä¼‘æ¯è£œå……é«”åŠ›ï¼Œå…é™¤ä¸‹ä¸€æ¬¡åœç•™æ‡²ç½° 1 æ¬¡", f: (p)=>{ p.skipImmunity++; }, i: "ğŸ”‹", ra: false }
                ]);
            } else nextTurn();
        } else if (t.specialType === 'sports') {
            triggerRandomSpecial(pos, [
                { t: "åƒåŠ å“¡å·¥é‹å‹•æ´»å‹•ï¼Œç²¾ç¥é£½æ»¿ï¼Œå†æ“²ä¸€æ¬¡", f: ()=>{}, i: "ğŸ¾", ra: true },
                { t: "ä¹…æœªé‹å‹•ï¼Œé«”åŠ›ä¸‹é™ï¼Œåœç•™ ä¸€å›åˆ", f: (p)=>{ if(p.skipImmunity > 0){ p.skipImmunity--; return "é«”åŠ›å°šå¯ï¼ŒæŠµæ¶ˆåœç•™ï¼"; } p.skipTurns = 1; }, i: "ğŸ˜«", ra: false },
                { t: "é‹å‹•å¾Œç‹€æ³è‰¯å¥½ï¼Œå·¥ä½œæ•ˆç‡æå‡ï¼Œçé‡‘ +200 å…ƒ", f: (p)=>{ p.balance += 200; }, i: "âš¡", ra: false }
            ]);
        } else if (t.specialType === 'restroom') {
            triggerRandomSpecial(pos, [
                { t: "æ´—æ‰‹æ™‚ç™¼ç¾åœ°é¢ç©æ°´ä¸¦å›å ±ï¼Œçé‡‘ +200 å…ƒ", f: (p)=>{ p.balance += 200; }, i: "ğŸ§¼", ra: false },
                { t: "ä¸Šç­å·æ»‘æ‰‹æ©Ÿè¢«ç™¼ç¾ï¼Œæ‰£ 100 å…ƒ", f: (p)=>{ p.balance -= 100; }, i: "ğŸ“±", ra: false },
                { t: "æ´—å®Œæ‰‹ç²¾ç¥æ¸…çˆ½ï¼Œå¿ƒæƒ…åŠ æˆï¼Œå†æ“²ä¸€æ¬¡", f: ()=>{}, i: "âœ¨", ra: true }
            ]);
        } else if (t.specialType === 'infirmary') {
            triggerRandomSpecial(pos, [
                { t: "è¼•å¾®æ‹‰å‚·ï¼Œæ¥å—ç°¡æ˜“æ²»ç™‚ï¼Œåœç•™ ä¸€å›åˆ", f: (p)=>{ if(p.skipImmunity > 0){ p.skipImmunity--; return "åŒ…ç´®å®Œç•¢ï¼Œå…åœç•™ï¼"; } p.skipTurns = 1; }, i: "ğŸ©¹", ra: false },
                { t: "ææ—©å›å ±ä¸é©ï¼Œé¿å…å·¥å®‰äº‹æ•…ï¼Œçé‡‘ +300 å…ƒ", f: (p)=>{ p.balance += 300; }, i: "ğŸ“¢", ra: false },
                { t: "å¥åº·æª¢æŸ¥æ­£å¸¸ï¼Œç›´æ¥é›¢é–‹é†«è­·å®¤ä¸¦ å†æ“²ä¸€æ¬¡", f: ()=>{}, i: "âœ…", ra: true }
            ]);
        } else {
            nextTurn();
        }
        renderBoard();
    }

    function triggerBank(p) {
        const propValue = Object.keys(p.owned_data).reduce((acc, idx) => acc + INITIAL_TILES[idx].price, 0);
        const totalAssets = p.balance + propValue;
        const maxLoan = Math.round(totalAssets * 0.8); // é¡åº¦ç‚ºç¸½è³‡ç”¢çš„ 80%

        document.getElementById('msg-title').innerText = "éŠ€è¡Œèè³‡æœå‹™";
        document.getElementById('msg-icon').innerText = "ğŸ¦";
        document.getElementById('msg-body').innerText = `åŸºæ–¼æŠ€è¡“å“¡ç•¶å‰è³‡ç”¢ ($${totalAssets})ï¼Œæœ€å¤§è²¸æ¬¾é¡åº¦ç‚ºï¼š$${maxLoan}ã€‚\né‚„æ¬¾ï¼šæ¯ç¶“éä¸­æ§å®¤æ‰£é™¤ 20%ï¼Œå…± 5 æœŸå„Ÿé‚„ã€‚`;
        
        const customContent = document.getElementById('msg-custom-content');
        customContent.innerHTML = '';
        customContent.classList.remove('hidden');

        if (p.loanDebt > 0) {
            customContent.innerHTML = `<div class="p-4 bg-red-50 text-red-600 rounded-2xl font-bold">ç•¶å‰å·²æœ‰è²¸æ¬¾é€²è¡Œä¸­ï¼Œæ¸…å„Ÿå‰ç„¡æ³•å†æ¬¡ç”³è²¸ã€‚</div>`;
        } else {
            [2000, 5000, maxLoan].forEach(amt => {
                const btn = document.createElement('button');
                btn.className = "w-full mb-3 bg-blue-600 text-white py-3 rounded-2xl font-black";
                btn.innerText = `å€Ÿè²¸ $${amt}`;
                btn.onclick = () => {
                    p.balance += amt;
                    p.loanDebt = amt;
                    p.loanInstallments = 5;
                    addLog(`ğŸ¦ ${p.name} å‘éŠ€è¡Œèè³‡ $${amt}`);
                    closeModal('msg-modal');
                    updatePlayersUI();
                    nextTurn();
                };
                customContent.appendChild(btn);
            });
        }
        document.getElementById('msg-modal').classList.add('active-modal');
    }

    function triggerRandomSpecial(pos, events) {
        const p = players[currentTurnPlayerIdx];
        const ev = events[Math.floor(Math.random() * events.length)];
        const extra = ev.f(p);
        rollAgain = ev.ra;
        showMsg(INITIAL_TILES[pos].name, (extra ? extra + "\n" : "") + ev.t, ev.i);
        addLog(`ğŸ“ ${p.name} æ–¼ ${INITIAL_TILES[pos].name}ï¼š${ev.t}`);
        updatePlayersUI();
        if (!rollAgain && INITIAL_TILES[p.pos].specialType !== 'rest' && !ev.t.includes('å¾€å‰')) nextTurn();
        else if (INITIAL_TILES[p.pos].specialType === 'rest') nextTurn();
        else updateTurnUI();
    }

    function triggerChanceOrFateEvent() {
        const p = players[currentTurnPlayerIdx];
        const oldPos = p.pos;
        const ev = CHANCE_EVENTS[Math.floor(Math.random() * CHANCE_EVENTS.length)];
        const extra = ev.effect(p);
        showMsg("æ©Ÿæœƒæˆ–å‘½é‹", (extra ? extra + "\n" : "") + ev.text, ev.icon);
        addLog(`ğŸ’¡ ${p.name} è§¸ç™¼ï¼š${ev.text}`);
        updatePlayersUI();
        if (p.pos !== oldPos) setTimeout(() => handleTile(p.pos, true), 800);
        else nextTurn();
    }

    function triggerMaintenance(pos, owner) {
        const p = players[currentTurnPlayerIdx];
        if (p.feeImmunity) {
            showMsg("ä¸»ç®¡è‡¨æª¢ä¸­", "æœ¬å›åˆå…é™¤æ”¯ä»˜ç¶­ä¿®è²»ï¼", "ğŸ›¡ï¸");
            nextTurn(); return;
        }
        const t = INITIAL_TILES[pos];
        const d = owner.owned_data[pos];
        let m = 1 + (d.level - 1) * 0.5;
        if (d.durability <= 0) m = 0; else if (d.durability < 50) m *= 0.5;
        const r = Math.random();
        let fee = 0; let type = "æ­£å¸¸ç”Ÿç”¢";
        if (m > 0) {
            if (r < 0.3) { fee = Math.round(t.fees.repair * m); type = "ğŸ’¥ ç·Šæ€¥ç¶­ä¿®"; }
            else if (r < 0.7) { fee = Math.round(t.fees.maint * m); type = "ğŸ”§ å®šæœŸä¿é¤Š"; }
        }
        if (fee > 0) {
            p.balance -= fee; owner.balance += fee;
            showMsg(type, `${p.name} æ”¯ä»˜ $${fee} ç¶­ä¿®è²»çµ¦ ${owner.name}`, "ğŸ’¸");
            addLog(`ğŸ’¸ ${p.name} å‘ ${owner.name} æ”¯ä»˜ $${fee}`);
        } else {
            showMsg("æ­£å¸¸ç”Ÿç”¢", d.durability <= 0 ? "è¨­å‚™åœæ©Ÿã€‚" : "é‹è½‰æ¥µä½³ã€‚", 'âœ…');
        }
        updatePlayersUI(); nextTurn();
    }

    function showPropModal(pos, canBuy = false, canUpgrade = false) {
        const t = INITIAL_TILES[pos];
        const p = players[currentTurnPlayerIdx];
        let ownerOfThis = players.find(player => player.owned_data[pos]);
        const d = (ownerOfThis ? ownerOfThis.owned_data[pos] : null) || { level: 1, upgrades: [], durability: 100 };
        
        document.getElementById('prop-name').innerText = t.name;
        document.getElementById('prop-price').innerText = `$${t.price || 0}`;
        let fullDesc = t.desc;
        if (ownerOfThis) {
            d.upgrades.forEach(upName => {
                const upInfo = t.upgrades.find(u => u.name === upName);
                if (upInfo && upInfo.upgradeNote) fullDesc += `\n\nã€å·²å®‰è£: ${upName}ã€‘\n${upInfo.upgradeNote}`;
            });
        }
        document.getElementById('prop-desc').innerText = fullDesc;
        document.getElementById('prop-level').innerText = `Lv.${d.level}`;
        document.getElementById('prop-color').style.backgroundColor = (t.specialType === 'start' ? 'var(--start-green)' : (t.type === 'special' ? 'var(--chrome-yellow)' : (t.color || '#3b82f6')));
        
        const durBar = document.getElementById('prop-durability-bar');
        const durText = document.getElementById('prop-durability-text');
        durBar.style.width = d.durability + '%';
        durBar.style.backgroundColor = d.durability > 50 ? '#10b981' : (d.durability > 0 ? '#f59e0b' : '#f43f5e');
        durText.innerText = `${d.durability}/100`;

        let m = 1 + (d.level - 1) * 0.5;
        if (d.durability <= 0) m = 0; else if (d.durability < 50) m *= 0.5;
        document.getElementById('prop-fee-repair').innerText = `-$${Math.round(t.fees.repair * m)}`;
        document.getElementById('prop-fee-maint').innerText = `-$${Math.round(t.fees.maint * m)}`;
        
        const actions = document.getElementById('prop-actions');
        actions.innerHTML = '';
        const upSection = document.getElementById('upgrade-section');
        const upList = document.getElementById('upgrade-list');
        document.getElementById('prop-price-container').style.display = 'flex';
        document.getElementById('prop-fees-container').style.display = 'grid';
        upSection.classList.add('hidden');
        
        if (canBuy && p.balance >= t.price) {
            const b = document.createElement('button');
            b.className = "w-full bg-blue-600 text-white py-5 rounded-[1.5rem] font-black shadow-lg";
            b.innerText = `æŠ•è³‡æ”¶è³¼ ($${t.price})`;
            b.onclick = () => buyProp(pos);
            actions.appendChild(b);
        }
        
        if (canUpgrade && t.upgrades) {
            upSection.classList.remove('hidden');
            upList.innerHTML = '';
            t.upgrades.forEach(u => {
                const has = d.upgrades.includes(u.name);
                const stepLock = u.type === 'step' && d.level < u.levelReq;
                const btn = document.createElement('button');
                btn.className = `p-4 rounded-2xl border-2 flex flex-col items-start text-left transition-all ${has ? 'bg-emerald-50 border-emerald-500' : (stepLock ? 'opacity-30 grayscale cursor-not-allowed' : 'bg-white hover:border-blue-400')}`;
                btn.disabled = has || stepLock;
                btn.innerHTML = `<div class="flex justify-between w-full font-black text-[12px]"><span>${u.name}</span><span class="text-blue-600">${has ? 'å·²å®‰è£' : '$' + u.price}</span></div>${u.upgradeNote ? `<div class="text-[12px] text-slate-500 mt-1 leading-tight">${u.upgradeNote}</div>` : ''}`;
                btn.onclick = () => upgradeProp(pos, u);
                upList.appendChild(btn);
            });
            if (ownerOfThis && d.durability < 100) {
                const refurbBtn = document.createElement('button');
                refurbBtn.className = "w-full bg-slate-800 text-white py-4 rounded-[1.5rem] font-black mt-2";
                refurbBtn.innerHTML = `ğŸ› ï¸ é‡æ–°è£ä¿® (æ¢å¾©æ¨™ç¤ºä¸¦é‡ç½®ç­‰ç´š)`;
                refurbBtn.onclick = () => refurbishProp(pos);
                actions.appendChild(refurbBtn);
            }
        }
        
        const closeBtn = document.createElement('button');
        closeBtn.className = "w-full bg-slate-100 text-slate-600 py-5 rounded-[1.5rem] font-black hover:bg-slate-200";
        closeBtn.innerText = "å®Œæˆä½œæ¥­";
        closeBtn.onclick = () => { closeModal('property-modal'); nextTurn(); };
        actions.appendChild(closeBtn);
        document.getElementById('property-modal').classList.add('active-modal');
    }

    function buyProp(pos) {
        const p = players[currentTurnPlayerIdx];
        const t = INITIAL_TILES[pos];
        p.balance -= t.price;
        p.owned_data[pos] = { level: 1, upgrades: [], durability: 100, visitCount: 0 };
        addLog(`ğŸ—ï¸ ${p.name} æ”¶è³¼ ${t.name}`);
        closeModal('property-modal'); updatePlayersUI(); nextTurn();
    }

    function upgradeProp(pos, upgrade) {
        const p = players[currentTurnPlayerIdx];
        if (p.balance >= upgrade.price) {
            p.balance -= upgrade.price;
            p.owned_data[pos].upgrades.push(upgrade.name);
            p.owned_data[pos].level += 1;
            addLog(`ğŸ› ï¸ ${p.name} å‡ç´š ${INITIAL_TILES[pos].name} è‡³ Lv.${p.owned_data[pos].level}`);
            closeModal('property-modal'); updatePlayersUI(); nextTurn();
        }
    }

    function refurbishProp(pos) {
        const p = players[currentTurnPlayerIdx];
        p.owned_data[pos].level = 1;
        p.owned_data[pos].upgrades = [];
        p.owned_data[pos].durability = 100;
        p.owned_data[pos].visitCount = 0;
        addLog(`â™»ï¸ ${p.name} é‡æ–°ä¿®ç¹• ${INITIAL_TILES[pos].name}`);
        closeModal('property-modal'); updatePlayersUI(); renderBoard(); nextTurn();
    }

    function handleSellCurrent() {
        const p = players[currentTurnPlayerIdx];
        if (p.owned_data[p.pos]) {
            const t = INITIAL_TILES[p.pos];
            p.balance += Math.round(t.price * 0.7);
            delete p.owned_data[p.pos];
            addLog(`ğŸ’° ${p.name} è®Šè³£è³‡ç”¢`);
            renderBoard(); updatePlayersUI();
        }
    }

    function nextTurn() {
        if (rollAgain) return;
        currentTurnPlayerIdx = (currentTurnPlayerIdx + 1) % players.length;
        updateTurnUI();
        updatePlayersUI();
    }

    function addLog(m) {
        const b = document.getElementById('game-logs');
        const d = document.createElement('div');
        d.className = "mb-3 border-l-4 border-blue-500 pl-4 text-[11px] py-1 bg-slate-800/50 rounded-r-lg";
        d.innerHTML = `<span class="text-slate-400 font-bold">[${new Date().toLocaleTimeString()}]</span> ${m}`;
        b.prepend(d);
    }

    function showMsg(t, b, i = 'ğŸ“¢') {
        document.getElementById('msg-title').innerText = t;
        document.getElementById('msg-body').innerText = b;
        document.getElementById('msg-icon').innerText = i;
        document.getElementById('msg-modal').classList.add('active-modal');
    }

    function closeModal(id) {
        document.getElementById(id).classList.remove('active-modal');
        document.getElementById('msg-custom-content').classList.add('hidden');
        if (rollAgain) updateTurnUI(); 
    }
</script>
</body>
</html>
