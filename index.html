<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é æ‹Œå» å¤§äº¨ - å°ˆæ¥­æµç¨‹æ•™å­¸ç‰ˆ (æœ¬åœ°å–®æ©Ÿ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --bg-industrial: #f8fafc; --chrome-yellow: #FFB900; --start-green: #10b981; }
        body { background-color: var(--bg-industrial); font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; overflow-x: hidden; }
        
        #game-board {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            grid-template-rows: repeat(9, 1fr);
            gap: 4px;
            width: 95vw;
            max-width: 850px;
            aspect-ratio: 1 / 1;
            margin: 10px auto;
            background: #cbd5e1;
            padding: 8px;
            border-radius: 20px;
            box-shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.15);
        }

        .tile {
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4px;
            font-size: 0.65rem;
            position: relative;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            min-height: 0;
            overflow: hidden;
        }

        .tile:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); z-index: 50; }
        .tile-header { height: 6px; width: 100%; position: absolute; top: 0; left: 0; border-radius: 8px 8px 0 0; }
        
        .tile-special { color: #1e293b; font-weight: 900; }
        .tile-yellow { background-color: var(--chrome-yellow) !important; }
        .tile-green { background-color: var(--start-green) !important; color: white; }

        .tile-no {
            position: absolute;
            top: 6px;
            left: 4px;
            font-size: 8px;
            color: #94a3b8;
            font-weight: 800;
        }
        
        .tile-special .tile-no { color: rgba(255, 255, 255, 0.4); }
        .tile-yellow .tile-no { color: rgba(30, 41, 59, 0.4); }

        .player-token {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            position: absolute;
            bottom: 6px;
            border: 2px solid white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.4);
            z-index: 60;
            transition: all 0.4s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: white;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.8);
            z-index: 100;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
        }
        .active-modal { display: flex; }

        .log-box {
            height: 350px;
            overflow-y: auto;
            background: #1e293b;
            color: #e2e8f0;
            padding: 16px;
            font-family: 'Fira Code', monospace;
            border-radius: 16px;
            font-size: 0.75rem;
            border: 1px solid #334155;
        }

        .board-center {
            grid-area: 2 / 2 / 9 / 9;
            background: rgba(255, 255, 255, 0.4);
            border: 4px dashed #e2e8f0;
            border-radius: 3rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 10px;
            pointer-events: none;
        }
        
        .start-label {
            font-size: 7px;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.2);
            padding: 1px 4px;
            border-radius: 4px;
            margin-top: 2px;
            text-transform: uppercase;
        }

        #setup-screen {
            position: fixed;
            inset: 0;
            background: var(--bg-industrial);
            z-index: 200;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="p-2 md:p-6 text-slate-800">

<!-- éŠæˆ²åˆå§‹è¨­å®šç•«é¢ -->
<div id="setup-screen">
    <div class="bg-white p-12 rounded-[3rem] shadow-2xl text-center max-w-md w-full mx-4 border-b-8 border-yellow-400">
        <h1 class="text-4xl font-black text-slate-800 mb-2 italic">é æ‹Œå» å¤§äº¨</h1>
        <p class="text-slate-400 font-bold mb-8 uppercase tracking-widest">å» å€ä½œæ¥­æµç¨‹æ•™å­¸ç³»çµ±</p>
        <p class="text-sm font-bold text-slate-600 mb-6">è«‹é¸æ“‡åƒèˆ‡ä½œæ¥­çš„äººæ•¸ï¼š</p>
        <div class="grid grid-cols-2 gap-4">
            <button onclick="startGame(1)" class="bg-slate-100 hover:bg-blue-500 hover:text-white py-4 rounded-2xl font-black transition-all">1 äººç·´ç¿’</button>
            <button onclick="startGame(2)" class="bg-slate-100 hover:bg-blue-500 hover:text-white py-4 rounded-2xl font-black transition-all">2 äººå°æˆ°</button>
            <button onclick="startGame(3)" class="bg-slate-100 hover:bg-blue-500 hover:text-white py-4 rounded-2xl font-black transition-all">3 äººç«¶è³½</button>
            <button onclick="startGame(4)" class="bg-slate-100 hover:bg-blue-500 hover:text-white py-4 rounded-2xl font-black transition-all">4 äººæœƒæˆ°</button>
        </div>
    </div>
</div>

<div class="max-w-7xl mx-auto">
    <header class="flex flex-col lg:flex-row justify-between items-center mb-8 bg-white p-6 rounded-[2rem] shadow-sm border-b-4 border-slate-200">
        <div class="text-center lg:text-left">
            <h1 class="text-3xl font-black text-slate-800 tracking-tighter italic">é æ‹Œå» å¤§äº¨ <span class="text-blue-600">OFFLINE</span></h1>
            <p id="user-info" class="text-xs text-slate-400 font-bold tracking-[0.2em] uppercase mt-1 italic">ç³»çµ±é‹è¡Œä¸­ - æœ¬åœ°æ•™å­¸æ¨¡å¼</p>
        </div>
        <div class="flex items-center gap-8 mt-4 lg:mt-0">
            <div class="bg-emerald-50 px-6 py-3 rounded-2xl border border-emerald-100 text-center">
                <p class="text-[10px] text-emerald-500 font-black uppercase tracking-widest">ç•¶å‰é¤˜é¡</p>
                <div id="player-balance" class="text-3xl font-black text-emerald-700">$ --</div>
            </div>
            <div id="turn-indicator" class="px-8 py-3 rounded-full font-black text-sm shadow-sm transition-all uppercase tracking-widest text-center text-white">æº–å‚™é–‹å§‹...</div>
        </div>
    </header>

    <div class="grid grid-cols-1 xl:grid-cols-4 gap-8">
        <div class="xl:col-span-1 space-y-6">
            <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100">
                <h3 class="font-black text-slate-700 mb-5 flex items-center gap-3 text-sm uppercase tracking-wide">
                    <span class="w-2 h-6 bg-yellow-400 rounded-full"></span> ä½œæ¥­å“¡æ¸…å–®
                </h3>
                <div id="players-list" class="space-y-3"></div>
            </div>
            <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100">
                <h3 class="font-black text-slate-700 mb-5 flex items-center gap-3 text-sm uppercase tracking-wide">
                    <span class="w-2 h-6 bg-blue-500 rounded-full"></span> å» å€é€šè¨Šæ—¥èªŒ
                </h3>
                <div id="game-logs" class="log-box"></div>
            </div>
        </div>

        <div class="xl:col-span-3">
            <div id="game-board"></div>
            <div class="mt-8 flex gap-4">
                <button id="roll-btn" class="flex-1 bg-slate-900 hover:bg-slate-800 text-white font-black py-6 rounded-3xl shadow-2xl transition-all text-xl flex items-center justify-center gap-4 group">
                    <span class="group-hover:rotate-12 transition-transform">ğŸ²</span> å•Ÿå‹•ç”Ÿç”¢å¾ªç’°
                </button>
                <button onclick="handleSellCurrent()" class="px-10 bg-white hover:bg-red-50 text-red-500 font-black rounded-3xl border-2 border-red-100 transition-all text-sm uppercase">
                    è®Šè³£è¨­å‚™
                </button>
            </div>
        </div>
    </div>
</div>

<!-- è¨­å‚™è³‡è¨Šå½ˆçª— -->
<div id="property-modal" class="modal">
    <div class="bg-white rounded-[2.5rem] p-10 max-w-lg w-full mx-4 shadow-2xl relative overflow-hidden">
        <div id="prop-color" class="absolute top-0 left-0 w-full h-4"></div>
        <div class="flex justify-between items-start mb-6">
            <div>
                <h2 id="prop-name" class="text-3xl font-black text-slate-800 mt-2">è¨­å‚™åç¨±</h2>
            </div>
            <div class="bg-blue-50 px-5 py-3 rounded-2xl border border-blue-100 text-center">
                <p class="text-[10px] text-blue-400 font-black uppercase">ç­‰ç´š</p>
                <p id="prop-level" class="text-2xl font-black text-blue-600">Lv.1</p>
            </div>
        </div>
        <div class="flex items-center gap-3 mb-6" id="prop-price-container">
            <span class="bg-slate-100 px-3 py-1 rounded-lg text-[10px] font-black text-slate-500 uppercase tracking-widest">å…¬å¸å ±åƒ¹</span>
            <span id="prop-price" class="text-2xl font-black text-slate-700">$0</span>
        </div>
        <div id="prop-desc" class="bg-slate-50 p-6 rounded-2xl text-sm text-slate-600 leading-relaxed border border-slate-100 mb-8 italic whitespace-pre-wrap">ä»‹ç´¹å…§å®¹è¼‰å…¥ä¸­...</div>
        <div id="upgrade-section" class="mb-8 hidden">
            <p class="font-black text-slate-700 text-xs uppercase mb-3 tracking-widest flex items-center gap-2">
                <span class="w-1 h-3 bg-yellow-400 rounded-full"></span> å‡ç´šé…ä»¶ (å¢åŠ è·¯éç¶­ä¿®è²»)
            </p>
            <div id="upgrade-list" class="space-y-3"></div>
        </div>
        <div class="grid grid-cols-2 gap-4 mb-8" id="prop-fees-container">
            <div class="p-4 bg-red-50 border border-red-100 rounded-2xl">
                <p class="text-[9px] text-red-400 font-black uppercase mb-1 tracking-wider">æ•…éšœç¶­ä¿®æ”¯å‡º</p>
                <p id="prop-fee-repair" class="text-xl font-black text-red-600">-$0</p>
            </div>
            <div class="p-4 bg-orange-50 border border-orange-100 rounded-2xl">
                <p class="text-[9px] text-orange-400 font-black uppercase mb-1 tracking-wider">å®šæœŸä¿é¤Šæ”¯å‡º</p>
                <p id="prop-fee-maint" class="text-xl font-black text-orange-600">-$0</p>
            </div>
        </div>
        <div class="flex gap-4" id="prop-actions"></div>
    </div>
</div>

<!-- è¨Šæ¯è¦–çª— -->
<div id="msg-modal" class="modal">
    <div class="bg-white rounded-[3rem] p-12 max-w-md w-full mx-4 text-center shadow-2xl border border-slate-100">
        <div id="msg-icon" class="text-8xl mb-8">ğŸ“¢</div>
        <h3 id="msg-title" class="text-2xl font-black text-slate-800 mb-4 tracking-tight">é€šçŸ¥å…§å®¹</h3>
        <p id="msg-body" class="text-slate-500 mb-10 text-lg leading-relaxed">ç”Ÿç”¢ç·šç‹€æ…‹æ›´æ–°ä¸­...</p>
        <button id="msg-confirm-btn" class="w-full bg-slate-900 text-white py-5 rounded-[1.5rem] font-black shadow-xl hover:bg-slate-800 transition-all text-xl">ç¢ºèªæ”¶æ‚‰</button>
    </div>
</div>

<script>
    // --- æœ¬åœ°éŠæˆ²ç‹€æ…‹ ---
    let players = [];
    let currentTurnPlayerIdx = 0;
    
    // --- åœ°åœ–è³‡æ–™å®šç¾© ---
    const INITIAL_TILES = [
        { type: 'special', name: 'ä¸­æ§å®¤', color: '#10b981', desc: 'å…¨å» çš„å¤§è…¦ï¼Œè² è²¬èª¿åº¦ã€ç›£æ§èˆ‡é…æ¯”ç®¡ç†ã€‚èµ·é»ã€‚', specialType: 'start' },
        { 
            type: 'prop', 
            name: 'å¡è»Šå¸æ–™æ–—', 
            price: 1200, 
            color: '#3b82f6', 
            desc: 'ç ‚çŸ³è»Šå¸æ–™æ‰¿æ¥çš„æ–—å­ï¼Œé€ééœ‡å‹•æ©Ÿæ­é…ç¯©ç¶²å¯ä»¥éç¯©æ²™å­è·ŸçŸ³é ­è®“é¡†ç²’ä¸æœƒéå¤§ã€‚', 
            fees:{repair:400, maint:150}, 
            upgrades:[
                {name:'å‡ç´š: æ”¶æ–™å®¤', price:1500, desc: 'æ”¶æ–™å®¤ä¸»è¦ä½œç‚ºç ‚çŸ³å…¥æ–™å‰çš„æ¥æ‡‰é»ï¼Œç ‚çŸ³è»Šå¸æ©Ÿå°‡æ–™å–®äº¤çµ¦æ”¶æ–™å®¤äººå“¡é€²è¡Œè¨˜éŒ„ï¼Œè€Œæ”¶æ–™å®¤äººå“¡å¯é€éçª—æˆ¶æŸ¥çœ‹å¸æ–™ç‹€æ³'},
                {name:'å‡ç´š: é˜²å¡µå±‹', price:2000, desc: 'é˜²å¡µå±‹ä¸»è¦ç‚ºé˜²æ­¢ç ‚çŸ³å¸æ–™æ™‚éå¤šçš„ç²‰å¡µæº¢æ•£é€ æˆæ±™æŸ“ï¼Œé›–å…¥æ–™é¢è¦–æ•´å€‹æ•é–‹ï¼Œä½†ä¸Šæ–¹æœƒåŠ è£çš®å¸¶æœ‰æ•ˆé é˜²ç²‰å¡µå¤–æ•£'}
            ]
        },
        { type: 'prop', name: 'å…¥åº«å°¾è¼ªåº§', price: 800, color: '#3b82f6', desc: 'å¸¶é‹æ©Ÿçš„æœ€æœ«ç«¯ï¼Œé ­å°¾ç›¸é€£æ”¯æ’æ•´å€‹å¸¶é‹æ©Ÿçš„è¼¸é€çš®å¸¶ï¼Œä½¿å…¶å¯ä»¥é€²è¡Œé€æ–™ã€‚', fees:{repair:300, maint:100} },
        { type: 'prop', name: 'å…¥åº«å°¾è¼ªæ®µ', price: 600, color: '#3b82f6', desc: 'ä¸‹æ–™è¡æ“Šé»ï¼Œä¸€èˆ¬æœƒåŠ è£ï¼“ï½ï¼”æ”¯ç·©è¡è¼ªä½œç‚ºç·©éœ‡ä½œç”¨ã€‚', fees:{repair:200, maint:80} },
        { type: 'prop', name: 'å…¥åº«æ©Ÿä¸­æ®µ', price: 1000, color: '#3b82f6', desc: 'è¼¸é€è¨­å‚™çš„æ ¸å¿ƒæ¡æ¶ï¼Œä¸€èˆ¬è¨­è¨ˆ10Mä¸€æ®µï¼Œå¸¶é‹æ©Ÿå‰è¡Œè¼ªè¨­è¨ˆé–“è·ç‚º1Mä¸€çµ„ï¼Œå›ç¨‹è¼ªç‚º2Mä¸€çµ„ã€‚', fees:{repair:350, maint:120} },
        { type: 'prop', name: 'å…¥åº«é ­è¼ªåº§', price: 900, color: '#3b82f6', desc: 'å¸¶é‹æ©Ÿæœ€é ­ç«¯ï¼Œé ­è¼ªåº§æ˜¯å¸¶å‹•ç«¯ä¸Šé¢å®‰è£é¦¬é”åŠæ¸›é€Ÿæ©Ÿã€‚', fees:{repair:300, maint:110} },
        { type: 'prop', name: 'åˆ†æ–™å¸¶é‹æ©Ÿ', price: 1500, color: '#a855f7', desc: 'éª¨æé€²è¡Œåˆ†å€‰ä½œæ¥­ï¼ŒæŠ•å…¥æŒ‡å®šçš„å€‰åˆ¥å…§é€²è¡Œå­˜æ”¾ã€‚', fees:{repair:500, maint:200} },
        { type: 'prop', name: 'åˆ†æ–™å¹³å°', price: 1200, color: '#a855f7', desc: 'ç‚ºå…«å¦è¨­è¨ˆï¼Œä¸»è¦ç”¨æ–¼ç¶­ä¿®åˆ†æ–™å¸¶é‹æ©Ÿçš„ä¸€å€‹å¹³å°ç©ºé–“ã€‚', fees:{repair:400, maint:150}, upgrades:[{name:'ä¸Šæ–¹èµ°å»Š', price:1000}]},
        { type: 'special', name: 'æ©Ÿæœƒæˆ–å‘½é‹', icon: 'â“', desc: 'ç”Ÿç”¢ä¸­çš„æœªçŸ¥è®Šæ•¸ã€‚', specialType: 'chance_or_fate' },
        { type: 'prop', name: 'éª¨æåº«', price: 3000, color: '#a855f7', desc: 'å››å¤§ä¸»é«”ä¹‹ä¸€ï¼Œå…·å‚™9Mã€10Mã€12Må¤šç¨®é«˜åº¦è¨­è¨ˆé¸æ“‡ã€‚', fees:{repair:1000, maint:400}, upgrades:[{name:'RCè…³æŸ±', price:2500},{name:'éµè£½è…³æŸ±', price:1500}]},
        { type: 'prop', name: 'ç ‚çŸ³é–˜é–€', price: 1300, color: '#a855f7', desc: 'ä¸‹æ–™é–‹é—œï¼Œç ‚é–˜ç‚ºå¼§å½¢è¨­è¨ˆï¼ŒçŸ³é–˜ç‚ºæŠ˜è§’è¨­è¨ˆã€‚å…·å‚™ç©ºæ´è¨­è¨ˆé¿å…çµå¡Šã€‚', fees:{repair:450, maint:150} },
        { type: 'prop', name: 'ç ‚çŸ³è¨ˆé‡æ¡¶', price: 2000, color: '#a855f7', desc: 'è¨ˆç®—æ¯”é‡è¨­å‚™ã€‚ç ‚è¨ˆé‡é è¿‘æœ«ç«¯è¥¯åº•ï¼ŒçŸ³é ­ç”¨è€ç£¨æ¿ï¼Œç ‚å­ç”¨ç™½éµæˆ–PEã€‚', fees:{repair:700, maint:250} },
        { type: 'prop', name: 'ä¸»å°¾è¼ªåº§', price: 1100, color: '#f97316', desc: 'å¸¶é‹æ©Ÿçš„æœ€æœ«ç«¯ï¼Œé ­å°¾ç›¸é€£æ”¯æ’æ•´å€‹å¸¶é‹æ©Ÿé€æ–™ã€‚', fees:{repair:400, maint:150} },
        { type: 'prop', name: 'ä¸»å°¾è¼ªæ®µ', price: 800, color: '#f97316', desc: 'ä¸‹æ–™æ‰€æ‰¿æ¥ä½ç½®ï¼ŒåŠ è£ï¼“ï½ï¼”æ”¯ç·©è¡è¼ªä½œç‚ºç·©éœ‡ã€‚', fees:{repair:300, maint:100} },
        { type: 'prop', name: 'ä¸»å¸¶æ©Ÿä¸­æ®µ', price: 1400, color: '#f97316', desc: 'æ ¸å¿ƒæ¡æ¶ï¼Œ10Mç‚ºä¸€æ®µï¼Œé–“è·å‰1Må¾Œ2Mã€‚', fees:{repair:500, maint:200} },
        { type: 'prop', name: 'ä¸»é ­è¼ªåº§', price: 1200, color: '#f97316', desc: 'å¸¶é‹æ©Ÿçš„æœ€é ­ç«¯ï¼Œå®‰è£é¦¬é”åŠæ¸›é€Ÿæ©Ÿä¾†é‹è½‰çš®å¸¶ã€‚', fees:{repair:400, maint:150} },
        { type: 'special', name: 'ä¼‘æ¯å®¤', icon: 'â˜•', desc: 'ä½œæ¥­å“¡ä¼‘æ¯èˆ‡äº¤ç­çš„å ´æ‰€ã€‚', specialType: 'rest' },
        { type: 'prop', name: 'éª¨æå¾…æ‹Œæ§½', price: 2200, color: '#06b6d4', desc: 'æå‰å°‡æ–™é€åˆ°å¾…æ‹Œæ§½å¾…å‘½ã€‚é›™å±¤è¨­è¨ˆå¯è®“ç ‚å­åšåº•ç·©è¡çŸ³é ­è¡æ“Šã€‚', fees:{repair:750, maint:300}, upgrades:[{name:'å–®å±¤å¼', price:1000},{name:'é›™å±¤å¼', price:1800}]},
        { type: 'prop', name: 'ç ‚çŸ³æ»‘æ§½', price: 1000, color: '#06b6d4', desc: 'æ˜¯éª¨æçš„éŠœæ¥åˆ°æ‹Œåˆæ©Ÿå…§çš„ä¸€å€‹æ§½é«”ã€‚', fees:{repair:300, maint:100} },
        { type: 'prop', name: 'æ°´æ³¥æ¡¶', price: 4000, color: '#06b6d4', desc: 'è† çµæå„²å­˜æ¡¶ï¼Œç›´å¾‘éš¨å®¹é‡å·®ç•°è¨­è¨ˆã€‚', fees:{repair:1500, maint:500}, upgrades:[{name:'æ¡¶ä¸Šé›†å¡µæ©Ÿ', price:1200},{name:'æ‰‹å‹•è¶é–¥', price:600}]},
        { type: 'prop', name: 'èºé‹æ©Ÿ', price: 1800, color: '#06b6d4', desc: 'è¼¸é€è† çµæè¨­å‚™ï¼Œé€éèºæ—‹å…§é é€æ–™ã€‚', fees:{repair:600, maint:200} },
        { type: 'prop', name: 'ç²‰é«”è¨ˆé‡æ¡¶', price: 2500, color: '#06b6d4', desc: 'è¨ˆç®—è† çµæè¨­å‚™ï¼Œç™½éµæœ¬é«”è¨­è¨ˆã€‚', fees:{repair:800, maint:300} },
        { type: 'prop', name: 'ç²‰é«”æ»‘æ§½', price: 800, color: '#06b6d4', desc: 'å¯†é–‰éŠœæ¥è¨­è¨ˆé˜²ç²‰å¡µï¼Œå®‰è£ä¸ç¹”å¸ƒç®¡é˜²æ‹‰æ‰¯æå£è¨­å‚™ã€‚', fees:{repair:250, maint:80} },
        { type: 'prop', name: 'ä¸»æ©Ÿé›†å¡µæ©Ÿ', price: 1800, color: '#06b6d4', desc: 'å¸å–æ‹Œåˆæ™‚çš„ç²‰å¡µï¼Œé€éè†œç‰‡é–¥éœ‡è½å›æ”¶å›æ©Ÿå…§ã€‚', fees:{repair:600, maint:200} },
        { type: 'special', name: 'æ©Ÿæœƒæˆ–å‘½é‹', icon: 'ğŸ’¡', desc: 'å·¥å®‰çå‹µæˆ–ç”Ÿç”¢è£œåŠ©ã€‚', specialType: 'chance_or_fate' },
        { type: 'prop', name: 'è—¥åŠ‘è¨ˆé‡è¨­å‚™', price: 1600, color: '#06b6d4', desc: 'è¨ˆç®—å„å¼è—¥åŠ‘æ¯”é‡ï¼Œå…¨ç™½éµè¨­è¨ˆã€‚å…·å‚™å…¥æ–™ç›’èˆ‡å›æ”¶ç›’æ©Ÿåˆ¶ã€‚', fees:{repair:500, maint:200}, upgrades:[{name: 'è—¥åŠ‘æš«å­˜æ¨¡çµ„', price: 1200}] },
        { type: 'prop', name: 'æ¸…æ°´æ¡¶', price: 1000, color: '#06b6d4', desc: 'å„²å­˜æ¸…æ°´ï¼ŒåŠ å¿«ç”Ÿç”¢æ•ˆç‡ã€‚', fees:{repair:300, maint:100}, upgrades:[{name: 'åŠ è£: å†°æ°´ç³»çµ±', price: 2000}]},
        { type: 'prop', name: 'ä¸»æ©Ÿæ±™æ°´æ”ªæ‹Œæ¡¶', price: 1800, color: '#06b6d4', desc: 'æ±™æ°´å›æ”¶åˆ©ç”¨ï¼Œå…·å‚™è‘‰ç‰‡æ”ªæ‹Œé˜²æ·¤æ³¥èˆ‡æ¸…æ´—ç‘æ°´ç³»çµ±ã€‚', fees:{repair:600, maint:250} },
        { type: 'prop', name: 'æ°´è¨ˆé‡æ¡¶', price: 1800, color: '#06b6d4', desc: 'è¨ˆç®—æ¸…æ°´ã€æ±™æ°´ã€å†°æ°´ä¹‹æ¯”é‡ã€‚', fees:{repair:600, maint:200} },
        { type: 'prop', name: 'æ°´ç·©è¡æ¡¶', price: 1200, color: '#f43f5e', desc: 'ç©©å®šå…¥æ°´æµé€Ÿä¹‹æ§½é«”ã€‚', fees:{repair:400, maint:150} },
        { type: 'prop', name: 'æ‹Œåˆæ©Ÿ', price: 6000, color: '#f43f5e', desc: 'é æ‹Œå» å¿ƒè‡Ÿã€‚æ°´å¹³é›™è»¸é¦¬é”ã€‚ä¸‰æ–¹ä¸»æ©Ÿä¸€åˆ†é˜ç”Ÿç”¢å…­æ–¹ã€‚', fees:{repair:2500, maint:800} },
        { type: 'prop', name: 'æ··å‡åœŸå„²æ–—', price: 2500, color: '#f43f5e', desc: 'æ··å‡åœŸæ··æ‹Œå®Œæˆå„²å­˜è¨­å‚™ï¼ŒåŠ å¿«å‡ºè»Šæ•ˆç‡ã€‚', fees:{repair:800, maint:300}, upgrades:[{name: 'åŠ è£: åŠ›éœ¸å¼å¤¾å…·', price: 3000}]}
    ];

    const CHANCE_EVENTS = [
        { text: "è€é—†è‡¨æ™‚å¤–æ´¾å‡ºå·®ï¼Œæš«åœä¸€å›åˆ", effect: p => p.skip = 1, icon: "ğŸ’¼" },
        { text: "ç”Ÿç—…ç™¼ç‡’åœ¨å®¶ä¼‘é¤Šï¼Œæš«åœä¸€å›åˆ", effect: p => p.skip = 1, icon: "ğŸ¤’" },
        { text: "é€”ä¸­æ©Ÿè»Šæ•…éšœé²åˆ°ï¼Œäº‹å‡æ‰£éŒ¢ 200 å…ƒ", effect: p => p.balance -= 200, icon: "ğŸ›µ" },
        { text: "æœªé…æˆ´å®‰å…¨å¸½è¢«æª¢èˆ‰ï¼Œæ‰£éŒ¢ 500 å…ƒ", effect: p => p.balance -= 500, icon: "ğŸ‘·" },
        { text: "å·¡æª¢å—å‚·ï¼Œå‰å¾€ä¼‘æ¯å®¤ä¼‘é¤Šä¸¦åœç•™ä¸€å›åˆ", effect: p => { p.pos = 16; p.skip = 1; }, icon: "ğŸ©¹" },
        { text: "ç›£å·¥å—å‚·ï¼Œå‰å¾€ä¼‘æ¯å®¤ä¼‘é¤Šä¸¦åœç•™ä¸€å›åˆ", effect: p => { p.pos = 16; p.skip = 1; }, icon: "ğŸ—ï¸" },
        { text: "å¤–æ´¾æ¥­å‹™å‡ºå·®ï¼Œè³ºå–åŠ ç­è²» 1500 å…ƒ", effect: p => p.balance += 1500, icon: "ğŸ’°" },
        { text: "å”åŠ©å®¢æˆ¶æ¶ä¿®è¨­å‚™ï¼Œè³ºå–çé‡‘ 1500 å…ƒ", effect: p => p.balance += 1500, icon: "ğŸ”§" },
        { text: "å·¥ä½œè¡¨ç¾è‰¯å¥½ï¼Œè³ºå–çé‡‘ 500 å…ƒ", effect: p => p.balance += 500, icon: "â­" }
    ];

    // --- åˆå§‹åŒ–æµç¨‹ ---
    function startGame(count) {
        const colors = ["#3b82f6", "#f43f5e", "#10b981", "#f59e0b"];
        const names = ["ä½œæ¥­å“¡ A", "ä½œæ¥­å“¡ B", "ä½œæ¥­å“¡ C", "ä½œæ¥­å“¡ D"];
        players = [];
        for (let i = 0; i < count; i++) {
            players.push({ id: i, name: names[i], pos: 0, balance: 15000, color: colors[i], owned: {}, skip: 0 });
        }
        document.getElementById('setup-screen').style.display = 'none';
        buildBoard();
        updateUI();
        addLog("ğŸ­ é æ‹Œå» ç”Ÿç”¢ç³»çµ±å•Ÿå‹• (æœ¬åœ°æ¨¡å¼)");
    }

    function buildBoard() {
        const board = document.getElementById('game-board');
        board.innerHTML = '';
        const side = 9;
        const coords = [];
        for (let x = 0; x < side; x++) coords.push({r: 1, c: x + 1});
        for (let y = 1; y < side - 1; y++) coords.push({r: y + 1, c: side});
        for (let x = side - 1; x >= 0; x--) coords.push({r: side, c: x + 1});
        for (let y = side - 2; y >= 1; y--) coords.push({r: y + 1, c: 1});

        INITIAL_TILES.forEach((data, idx) => {
            const div = document.createElement('div');
            const isSpecial = ['start', 'chance_or_fate', 'rest'].includes(data.specialType || '');
            div.className = `tile ${isSpecial ? 'tile-special' : ''} ${data.specialType === 'start' ? 'tile-green' : (isSpecial ? 'tile-yellow' : '')}`;
            div.dataset.idx = idx;
            div.style.gridRow = coords[idx].r;
            div.style.gridColumn = coords[idx].c;
            
            if (!isSpecial) {
                const header = document.createElement('div');
                header.className = 'tile-header';
                header.style.backgroundColor = data.color || '#3b82f6';
                div.appendChild(header);
            }

            div.innerHTML += `<div class="tile-no">#${idx + 1}</div>`;
            const nameDiv = document.createElement('div');
            nameDiv.className = 'font-black px-1 mt-2 text-[8px] leading-tight break-words';
            if (data.name === "ä¸»æ©Ÿæ±™æ°´æ”ªæ‹Œæ¡¶") nameDiv.innerHTML = 'ä¸»æ©Ÿæ±™æ°´<br>æ”ªæ‹Œæ¡¶';
            else if (data.name.length > 6) nameDiv.innerHTML = data.name.substring(0, 4) + '<br>' + data.name.substring(4);
            else nameDiv.innerText = data.name;
            div.appendChild(nameDiv);

            if (data.specialType === 'start') div.innerHTML += '<div class="start-label">èµ·é»</div>';
            if (isSpecial && data.icon) div.innerHTML += `<div class="text-xl mt-1 opacity-60">${data.icon}</div>`;
            else if (!isSpecial && data.price) div.innerHTML += `<div class="text-blue-500 font-bold mt-1 text-[7px] tracking-tight">$${data.price}</div>`;
            
            board.appendChild(div);
        });

        const center = document.createElement('div');
        center.className = 'board-center';
        center.innerHTML = `<div class="text-slate-300 font-black text-6xl rotate-[-15deg] opacity-60 tracking-widest">LOOP</div>`;
        board.appendChild(center);
    }

    function updateUI() {
        const listDiv = document.getElementById('players-list');
        listDiv.innerHTML = '';
        document.querySelectorAll('.player-token').forEach(el => el.remove());
        document.querySelectorAll('.tile').forEach(el => el.style.boxShadow = '0 2px 4px rgba(0,0,0,0.05)');

        players.forEach((p, idx) => {
            const div = document.createElement('div');
            const isCurrent = idx === currentTurnPlayerIdx;
            div.className = `p-3 rounded-2xl flex justify-between items-center text-[10px] shadow-sm border ${isCurrent ? 'bg-blue-50 border-blue-200 font-black' : 'bg-white border-transparent'}`;
            div.innerHTML = `<span><span style="color:${p.color}">â—</span> ${p.name} ${p.skip > 0 ? '(æš«åœä¸­)' : ''}</span><span>$${p.balance}</span>`;
            listDiv.appendChild(div);

            if (isCurrent) document.getElementById('player-balance').innerText = `$${p.balance}`;

            const tile = document.querySelector(`[data-idx="${p.pos}"]`);
            if (tile) {
                const token = document.createElement('div');
                token.className = 'player-token';
                token.style.backgroundColor = p.color;
                token.innerText = p.name.slice(-1);
                token.style.left = `${(idx * 4) + 2}px`;
                token.style.bottom = `${(idx * 2) + 4}px`;
                tile.appendChild(token);
            }

            Object.keys(p.owned).forEach(tIdx => {
                const el = document.querySelector(`[data-idx="${tIdx}"]`);
                if (el) el.style.boxShadow = `inset 0 0 0 4px ${p.color}`;
            });
        });

        const ind = document.getElementById('turn-indicator');
        ind.innerText = `è¼ªåˆ° ${players[currentTurnPlayerIdx].name}`;
        ind.style.backgroundColor = players[currentTurnPlayerIdx].color;
    }

    // --- å‹•ä½œè™•ç† ---
    document.getElementById('roll-btn').onclick = () => {
        const p = players[currentTurnPlayerIdx];
        if (p.skip > 0) {
            p.skip--;
            addLog(`â³ ${p.name} åœç•™ä¼‘é¤Šä¸­ï¼Œæœ¬å›åˆè·³éã€‚`);
            showMsg("ä½œæ¥­åœç•™", `${p.name} æ­£åœ¨ä¼‘é¤Šï¼Œæœ¬å›åˆæš«åœã€‚`, "â³", () => nextTurn());
            return;
        }

        const dice = Math.floor(Math.random() * 6) + 1;
        addLog(`ğŸ² ${p.name} æ“²å‡ºäº† ${dice} é»`);
        
        let nextPos = (p.pos + dice) % INITIAL_TILES.length;
        if (nextPos < p.pos) {
            p.balance += 3000;
            addLog(`ğŸ”„ ${p.name} å®Œæˆå¾ªç’°ï¼Œé ˜å–è£œåŠ©é‡‘ $3000`);
        }
        p.pos = nextPos;
        updateUI();
        setTimeout(() => landOnTile(nextPos), 300);
    };

    function landOnTile(pos, isEventMove = false) {
        const t = INITIAL_TILES[pos];
        const p = players[currentTurnPlayerIdx];

        if (t.type === 'prop') {
            const owner = players.find(x => x.owned[pos]);
            if (!owner) {
                showPropModal(pos, true);
            } else if (owner.id === p.id) {
                // å¦‚æœç‰©ä¸»åœç•™åœ¨å¡è»Šå¸æ–™æ–— (index 1)ï¼Œæª¢æŸ¥ç‰©ä¸»äº‹ä»¶
                if (pos === 1) {
                    const r = Math.random();
                    if (r < 0.15) { // 15% è§¸ç™¼ç‡
                        const r2 = Math.random();
                        if (r2 < 0.33) {
                            p.balance -= 500;
                            showMsg("è¨­å‚™æ•…éšœ", "å¡è»Šå¸æ–™æ–—ï¼šéœ‡å‹•é¦¬é”æ•…éšœæ´¾äººç¶­ä¿®ï¼Œæ”¯ä»˜ 500 å…ƒã€‚", "ğŸ”§", () => showPropModal(pos, false, true));
                            addLog(`ğŸ’¸ ${p.name} æ”¯ä»˜å¸æ–™æ–—ç¶­ä¿®è²» $500`);
                        } else if (r2 < 0.66) {
                            p.balance -= 3000;
                            showMsg("è€—ææ›´æ›", "å¡è»Šå¸æ–™æ–—ï¼šç¯©ç¶²ä½¿ç”¨å£½å‘½åˆ°ï¼Œå¿ç—›æ›´æ›ï¼Œæ”¯ä»˜ 3000 å…ƒã€‚", "ğŸ’¸", () => showPropModal(pos, false, true));
                            addLog(`ğŸ’¸ ${p.name} æ”¯ä»˜ç¯©ç¶²æ›´æ›è²» $3000`);
                        } else {
                            p.balance -= 1500;
                            showMsg("é›¶ä»¶ç£¨æ", "å¡è»Šå¸æ–™æ–—ï¼šå…§è¥¯ç£¨æåš´é‡ï¼Œæ´¾äººæ›´æ›ï¼Œæ”¯ä»˜ 1500 å…ƒã€‚", "ğŸ› ï¸", () => showPropModal(pos, false, true));
                            addLog(`ğŸ’¸ ${p.name} æ”¯ä»˜å…§è¥¯æ›´æ›è²» $1500`);
                        }
                        return; // ç­‰è¨Šæ¯ç¢ºèªå¾Œå†é–‹è¦–çª—
                    }
                }
                showPropModal(pos, false, true);
            } else {
                triggerRent(pos, owner);
            }
        } else if (t.specialType === 'chance_or_fate') {
            triggerChance();
        } else if (t.specialType === 'rest') {
            if (!isEventMove) {
                p.skip = 1;
                showMsg("ä¼‘æ¯å®¤", "ç”¨è…¦éåº¦æ‘¸é­šä¸€ä¸‹", "â˜•", () => nextTurn());
                addLog(`â³ ${p.name} ä¼‘æ¯æ‘¸é­šä¸­ã€‚`);
            } else {
                nextTurn();
            }
        } else {
            nextTurn();
        }
    }

    function showPropModal(pos, buyable = false, upgradeable = false) {
        const t = INITIAL_TILES[pos];
        const p = players[currentTurnPlayerIdx];
        const owner = players.find(x => x.owned[pos]);
        const d = (owner ? owner.owned[pos] : null) || { lv: 1, up: [] };

        document.getElementById('prop-name').innerText = t.name;
        document.getElementById('prop-price').innerText = `$${t.price}`;
        
        // å‹•æ…‹è¨­å‚™æè¿°
        let currentDesc = t.desc;
        if (d.lv === 2 && t.upgrades && t.upgrades[0]) currentDesc = t.upgrades[0].desc;
        if (d.lv >= 3 && t.upgrades && t.upgrades[1]) currentDesc = t.upgrades[1].desc;
        document.getElementById('prop-desc').innerText = currentDesc;
        
        document.getElementById('prop-level').innerText = `Lv.${d.lv}`;
        document.getElementById('prop-color').style.backgroundColor = t.color;
        
        const m = 1 + (d.lv - 1) * 0.5;
        document.getElementById('prop-fee-repair').innerText = `-$${Math.round(t.fees.repair * m)}`;
        document.getElementById('prop-fee-maint').innerText = `-$${Math.round(t.fees.maint * m)}`;
        
        const actions = document.getElementById('prop-actions');
        actions.innerHTML = '';
        const upSection = document.getElementById('upgrade-section');
        const upList = document.getElementById('upgrade-list');
        upSection.classList.add('hidden');

        if (buyable && p.balance >= t.price) {
            const b = document.createElement('button');
            b.className = "flex-1 bg-blue-600 text-white py-5 rounded-[1.5rem] font-black shadow-lg";
            b.innerText = `æ”¶è³¼ç®¡ç† ($${t.price})`;
            b.onclick = () => {
                p.balance -= t.price;
                p.owned[pos] = { lv: 1, up: [] };
                addLog(`ğŸ—ï¸ ${p.name} å·²å–å¾— ${t.name}`);
                closeModal('property-modal'); nextTurn();
            };
            actions.appendChild(b);
        }

        if (upgradeable && t.upgrades) {
            upSection.classList.remove('hidden');
            upList.innerHTML = '';
            t.upgrades.forEach((u, uIdx) => {
                const isNextUpgrade = (d.lv === uIdx + 1);
                const has = d.up.includes(u.name);
                const btn = document.createElement('button');
                btn.className = `p-4 rounded-2xl border-2 flex justify-between items-center text-xs transition-all ${has ? 'bg-emerald-50 border-emerald-500 font-bold' : (isNextUpgrade ? 'bg-white hover:border-blue-400' : 'opacity-30 grayscale')}`;
                btn.disabled = has || !isNextUpgrade;
                btn.innerHTML = `<span>${u.name}</span><span class="font-black text-blue-600">${has ? 'å·²å®‰è£' : '$' + u.price}</span>`;
                btn.onclick = () => {
                    if (p.balance >= u.price) {
                        p.balance -= u.price;
                        d.up.push(u.name); d.lv++;
                        addLog(`ğŸ› ï¸ ${p.name} å‡ç´šé…ä»¶ï¼š${u.name}`);
                        closeModal('property-modal'); nextTurn();
                    }
                };
                upList.appendChild(btn);
            });
        }

        const close = document.createElement('button');
        close.className = "px-10 bg-slate-100 text-slate-600 py-5 rounded-[1.5rem] font-black hover:bg-slate-200";
        close.innerText = "çµæŸä½œæ¥­";
        close.onclick = () => { closeModal('property-modal'); nextTurn(); };
        actions.appendChild(close);
        document.getElementById('property-modal').classList.add('active-modal');
    }

    function triggerRent(pos, owner) {
        const p = players[currentTurnPlayerIdx];
        const t = INITIAL_TILES[pos];
        const m = 1 + (owner.owned[pos].lv - 1) * 0.5;
        const r = Math.random();
        let fee = 0; let type = "";

        if (r < 0.3) { fee = Math.round(t.fees.repair * m); type = "ğŸ’¥ ç·Šæ€¥ç¶­ä¿®"; }
        else if (r < 0.7) { fee = Math.round(t.fees.maint * m); type = "ğŸ”§ å®šæœŸä¿é¤Š"; }

        if (fee > 0) {
            p.balance -= fee; owner.balance += fee;
            showMsg(type, `é€²å…¥ ${owner.name} çš„ç®¡ç†å€ï¼Œæ”¯ä»˜è²»ç”¨ $${fee}ã€‚`, "ğŸ’¸", () => nextTurn());
            addLog(`ğŸ’¸ ${p.name} æ”¯ä»˜ç¶­ä¿®è²» $${fee} çµ¦ ${owner.name}`);
        } else {
            showMsg("é †åˆ©ç”Ÿç”¢", `${t.name} é‹è½‰æ¥µä½³ï¼Œç„¡éœ€æ”¯ä»˜ã€‚`, "âœ…", () => nextTurn());
        }
    }

    function triggerChance() {
        const p = players[currentTurnPlayerIdx];
        const ev = CHANCE_EVENTS[Math.floor(Math.random() * CHANCE_EVENTS.length)];
        const oldPos = p.pos;
        ev.effect(p);
        showMsg("æ©Ÿæœƒæˆ–å‘½é‹", ev.text, ev.icon, () => {
            if (p.pos !== oldPos && p.pos === 16) {
                updateUI();
                nextTurn();
            } else {
                nextTurn();
            }
        });
        addLog(`ğŸ’¡ ${p.name}ï¼š${ev.text}`);
    }

    function handleSellCurrent() {
        const p = players[currentTurnPlayerIdx];
        if (p.owned[p.pos]) {
            const ref = Math.round(INITIAL_TILES[p.pos].price * 0.7);
            p.balance += ref; delete p.owned[p.pos];
            addLog(`ğŸ’° ${p.name} è®Šè³£è¨­å‚™ï¼Œå›æ”¶ $${ref}`);
            updateUI();
        }
    }

    function nextTurn() {
        currentTurnPlayerIdx = (currentTurnPlayerIdx + 1) % players.length;
        updateUI();
    }

    function addLog(m) {
        const b = document.getElementById('game-logs');
        const d = document.createElement('div');
        d.className = "mb-3 border-l-4 border-blue-500 pl-4 text-[11px] py-2 bg-slate-800/40 rounded-r-lg";
        d.innerHTML = `<span class="text-slate-400 font-bold">[${new Date().toLocaleTimeString()}]</span> ${m}`;
        b.prepend(d);
    }

    function showMsg(t, b, i, callback) {
        document.getElementById('msg-title').innerText = t;
        document.getElementById('msg-body').innerText = b;
        document.getElementById('msg-icon').innerText = i;
        document.getElementById('msg-confirm-btn').onclick = () => {
            closeModal('msg-modal');
            if (callback) callback();
        };
        document.getElementById('msg-modal').classList.add('active-modal');
    }

    function closeModal(id) { document.getElementById(id).classList.remove('active-modal'); }
</script>
</body>
</html>
